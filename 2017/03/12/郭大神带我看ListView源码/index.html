<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="以下是我的一些阅读源码的完整过程，如果是纯粹追求内容的读者，可能这篇文章不适合你
系列开始前依然由我我来扯一扯，为什么会出现这个玩意？开始博客第一周了。这篇是我的第七篇博客，一周没断更。毕竟之前就有写随笔的习惯，所以写博客没有太消耗自己的时间，而且正好我计划当中的一些事情，已经完成。原先的那个时间段，就很自然的让给了博客。
看源码是对于一个开发者很有提升的东西，但是相应的也是拥有一些门槛的。没有人">
<meta property="og:type" content="article">
<meta property="og:title" content="郭大神带我看ListView源码">
<meta property="og:url" content="http://yoursite.com/2017/03/12/郭大神带我看ListView源码/index.html">
<meta property="og:site_name" content="JianRan">
<meta property="og:description" content="以下是我的一些阅读源码的完整过程，如果是纯粹追求内容的读者，可能这篇文章不适合你
系列开始前依然由我我来扯一扯，为什么会出现这个玩意？开始博客第一周了。这篇是我的第七篇博客，一周没断更。毕竟之前就有写随笔的习惯，所以写博客没有太消耗自己的时间，而且正好我计划当中的一些事情，已经完成。原先的那个时间段，就很自然的让给了博客。
看源码是对于一个开发者很有提升的东西，但是相应的也是拥有一些门槛的。没有人">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/006o5OgAly1fdk8d8z87ij30k307wgm6">
<meta property="og:updated_time" content="2017-05-31T15:22:07.993Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="郭大神带我看ListView源码">
<meta name="twitter:description" content="以下是我的一些阅读源码的完整过程，如果是纯粹追求内容的读者，可能这篇文章不适合你
系列开始前依然由我我来扯一扯，为什么会出现这个玩意？开始博客第一周了。这篇是我的第七篇博客，一周没断更。毕竟之前就有写随笔的习惯，所以写博客没有太消耗自己的时间，而且正好我计划当中的一些事情，已经完成。原先的那个时间段，就很自然的让给了博客。
看源码是对于一个开发者很有提升的东西，但是相应的也是拥有一些门槛的。没有人">
<meta name="twitter:image" content="http://ww1.sinaimg.cn/large/006o5OgAly1fdk8d8z87ij30k307wgm6">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2017/03/12/郭大神带我看ListView源码/"/>





  <title> 郭大神带我看ListView源码 | JianRan </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  














  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JianRan</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/03/12/郭大神带我看ListView源码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="JianRan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JianRan">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                郭大神带我看ListView源码
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-12T23:34:24+08:00">
                2017-03-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/2017-3/" itemprop="url" rel="index">
                    <span itemprop="name">2017-3</span>
                  </a>
                </span>

                
                
              
            </span>
          

          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><em>以下是我的一些阅读源码的完整过程，如果是纯粹追求内容的读者，可能这篇文章不适合你</em></p>
<p>系列开始前依然由我我来扯一扯，为什么会出现这个玩意？开始博客第一周了。这篇是我的第七篇博客，一周没断更。毕竟之前就有写随笔的习惯，所以写博客没有太消耗自己的时间，而且正好我计划当中的一些事情，已经完成。原先的那个时间段，就很自然的让给了博客。</p>
<p>看源码是对于一个开发者很有提升的东西，但是相应的也是拥有一些门槛的。没有人带着看或者独自一人看的话很容易深陷代码细节不能自拔。当然对于一个学习Android刚满一年的人来说，就算是纯粹的代码依然有很多东西可以学习，不过我们看源码的主要目的不是这个，而了解主体思路，如果有时间看看细节也无妨。</p>
<p>这个系列本打算一周一大篇的，希望自己可以做到，好好加油吧~~。这一整天在看的过程当中，就算是已经跟着郭神的博客走了一遍，自己深入依然难度重重，我在这里会尽量用我可以描述的语言记录下来。</p>
<hr>
<p>看源码的时候思维一定要活跃，积极思考，看别人的代码是一个脑力活。你要不停地猜各种各样的事情，而且攻略之前，如果是Android本身的，不妨看一下API的继承图和简单的介绍，总之尽可能多的获取相关的信息。事不宜迟我们是时候开车了~。</p>
<blockquote>
<p>在看这些文档的时候，一定要看他的注释，一般有注释的地方都是比较重要的地方，并且这些注释可以帮助你去更好的理解。</p>
</blockquote>
<p>简单看一下继承图，ListView和GridView他的直接父类是AbsListView，换句话说，AbsListView的直接子类是ListView和GridView。ListView和GridView他们是十分类似的，按照面向对象语言的尿性，肯定会抽取出这两个的共同的一些特点。具体可能是什么，每个人都有每个人的思考我就不说了。只是我们看源码的时候要关注一下AbsListView,这里面必然有很重要的机制。<br><img src="http://ww1.sinaimg.cn/large/006o5OgAly1fdk8d8z87ij30k307wgm6" alt=""></p>
<p>这里看一下AbsListView的注释对于这个对象的描述</p>
<blockquote>
<p>Base class that can be used to implement virtualized lists of<br>items. A list does not have a spatial definition here. For<br>instance, subclases of this class can display the content of the<br>list in a grid, in a carousel, as stack, etc.</p>
</blockquote>
<p>这里描述，这是一个基础的类，这个类可以被使用去实现一些虚拟的列表，它后面举了一些例子。<br>到目前为止，如果不切入主题，我自己能获得帮助理解的信息都已经获取完毕，是时候开始了。</p>
<p>今天的要看的是ListView的源码。看源码切勿从头开始看，因为代码简直太多了，以我的能力（学生，刻苦自学小一年）马上就会陷入代码细节当中，可能不光我这样。我们应该选择一个我们平时比较熟悉的，之后我们马上就可以想起下面这两行。</p>
<pre><code>ListView list = (ListView) findViewById(R.id.listView);
list.setAdapter(MyAdapter);
</code></pre><p>一个行是获取ListVie的实例对象，显然没有用处。那么第二行setAdapter(),这个是一个ListView的一个方法，看来我们找到入手点了。</p>
<h2 id="setAdapter-ListAdapter-adapter"><a href="#setAdapter-ListAdapter-adapter" class="headerlink" title="setAdapter(ListAdapter adapter)"></a>setAdapter(ListAdapter adapter)</h2><p>我们依然优先看注释<br><strong>Sets the data behind this ListView. The adapter passed to this method may be wrapped by a {@link WrapperListAdapter}, depending on the ListView features currently in use. For instance, adding headers and/or footers will cause the adapter to be wrapped.</strong></p>
<p>他说设置的这些信息会用于ListView，这个adapter通过这个方法可能被WrapperListAdapter包裹，被包装成什么样子，这个取决于当前ListView的一些特点，就比如说，在这些信息的头部和尾部添加一些内容。（就好像被包裹住了一样）</p>
<p>知道这些信息感觉对于了解ListView并没有什么帮助，接下来我们进入到setAdapter的源码，在其中你可能会发现一些你认为有用的方法，就比如<em>resetList()</em> , <em>requestLayout()</em>,但是你进入到具体内容发现,对于深入理解ListView并没有什么帮助，到这里我们目前可以想到的切入点已经断了。</p>
<p>我们应该开始思考了，我还可以朝着哪里进入呢？</p>
<p>ListView怎么说也是一个View，对于一个View来说,onMeasure,onLayout,onDraw,三个方法首当其冲，onMeasure是用于测量的数据的，重要的内容基本不会在这里，onDraw就是用来绘制的，真正的核心不会在这里。onLayout是真正放置布局的地方，所以核心极有可能在这里。</p>
<blockquote>
<p>写到这里我去上了个厕所，看了一篇万维钢老师的文章，题目是《失败不是成功之母，成功是成功之母》，真正对于失败有价值的有三点要素：<br>1、及时。一旦不对马上就有人给你指出来。<br>2、对事不对人。你错了，下次改正过来就是，没有必要上升到“你这个人行不行”的层面<br>3、错误的代价很小。<br>对于咱们刚才的失误，大可放心吸收经验就是，刚才的失败正是所谓的有效的失败、成功的失败。<br>抱歉大家我有稍微扯了一扯</p>
</blockquote>
<p>稍微打断了一下思路，但是在前进之前，我们吸取教训我们大致通读一下注释，当然信息量比较多，但是在这里花时间是值得的。对于大体有一个了解之后，我们再继续。我们在做事情之前，先宏观把控然后再具体分析，就会简单多了，或许你认为这会很浪费时间，但是目前来说是必由之路。</p>
<p>我们大体阅读之后，发现AbsListView中有个很重要的内部类<strong>RecycleBin</strong><br>我们依然看注释！</p>
<p><strong>The RecycleBin facilitates reuse of views across layouts. The RecycleBin has two levels of storage: ActiveViews and ScrapViews. ActiveViews are those views which were onscreen at the start of a layout. By construction, they are displaying current information. At the end of layout, all views in ActiveViews are demoted to ScrapViews. ScrapViews are old views that could potentially be used by the adapter to avoid allocating views unnecessarily.</strong></p>
<p>我简单说一下这个的意思，RecycleBin会帮助我们重新利用View，这个RecycleBin有两个等级存储： ActiveViews and ScrapViews。ActiviteViews 是指正在屏幕上的Views。通过构造函数，他们展现当前的信息， At the end of layout（我翻译不出来味道，就拿原文了），所有在ActiveViews中的view都会被降级进入ScrapViews。ScrapViews是一些老的View，并且未来可能被使用的，在这里保存，可以避免必要的分配View。看完了，这个内部类真的很关键！！！<br>这个内部类里面有几个重要的方法，我这个直接说明了，这个对于后面的理解都很有帮助（这里我直接粘贴了郭神一段）</p>
<ul>
<li><p><strong>fillActiveViews()</strong> 这个方法接收两个参数，第一个参数表示要存储的view的数量，第二个参数表示ListView中第一个可见元素的position值。RecycleBin当中使用mActiveViews这个数组来存储View，调用这个方法后就会根据传入的参数来将ListView中的指定元素存储到mActiveViews数组当中。</p>
</li>
<li><p><strong>getActiveView()</strong> 这个方法和fillActiveViews()是对应的，用于从mActiveViews数组当中获取数据。该方法接收一个position参数，表示元素在ListView当中的位置，方法内部会自动将position值转换成mActiveViews数组对应的下标值。需要注意的是，mActiveViews当中所存储的View，一旦被获取了之后就会从mActiveViews当中移除，下次获取同样位置的View将会返回null，也就是说mActiveViews不能被重复利用。</p>
</li>
<li><p><strong>addScrapView()</strong> 用于将一个废弃的View进行缓存，该方法接收一个View参数，当有某个View确定要废弃掉的时候(比如滚动出了屏幕)，就应该调用这个方法来对View进行缓存，RecycleBin当中使用mScrapViews和mCurrentScrap这两个List来存储废弃View。</p>
</li>
<li><p><strong>getScrapView</strong> 用于从废弃缓存中取出一个View，这些废弃缓存中的View是没有顺序可言的，因此getScrapView()方法中的算法也非常简单，就是直接从mCurrentScrap当中获取尾部的一个scrap view进行返回。</p>
</li>
<li><p><strong>setViewTypeCount()</strong> 我们都知道Adapter当中可以重写一个getViewTypeCount()来表示ListView中有几种类型的数据项，而setViewTypeCount()方法的作用就是为每种类型的数据项都单独启用一个RecycleBin缓存机制。实际上，getViewTypeCount()方法通常情况下使用的并不是很多，所以我们只要知道RecycleBin当中有这样一个功能就行了。</p>
</li>
</ul>
<p>我们继续往下，开始看onLayout(),当你搜索到的时候，你会发现在ListView里面没有，那么肯定就在他的父类里面了，果然在AbsListView中，这个注释还写着，子类不应该复写这个方法，而应该替换layoutChildren(),到这里我们应该知道了，主要的核心逻辑大概都在layoutChildren()这个方法中体现。但是我们依然看一下onLayout方法</p>
<h2 id="第一次layout"><a href="#第一次layout" class="headerlink" title="第一次layout"></a>第一次layout</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onLayout(changed, l, t, r, b);</div><div class="line"></div><div class="line">        mInLayout = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line">        <span class="keyword">if</span> (changed) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">                getChildAt(i).forceLayout();</div><div class="line">            &#125;</div><div class="line">            mRecycler.markChildrenDirty();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        layoutChildren();</div><div class="line">        mInLayout = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        mOverscrollMax = (b - t) / OVERSCROLL_LIMIT_DIVISOR;</div><div class="line"></div><div class="line">        <span class="comment">// <span class="doctag">TODO:</span> Move somewhere sane. This doesn't belong in onLayout().</span></div><div class="line">        <span class="keyword">if</span> (mFastScroll != <span class="keyword">null</span>) &#123;</div><div class="line">            mFastScroll.onItemCountChanged(getChildCount(), mItemCount);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>onLayout()方法中并没有做什么复杂的逻辑操作，主要就是一个判断，如果ListView的大小或者位置发生了变化，那么changed变量就会变成true，此时会要求所有的子布局都强制进行重绘。除此之外倒没有什么难理解的地方了，不过我们注意到，在第14行调用了layoutChildren()这个方法,我们进入这个layoutChildren()方法中，发现他是一个空方法，不过也正常，刚才上面也提到了，这个方法应该被子类所替换，所以我们去ListView中找这个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> blockLayoutRequests = mBlockLayoutRequests;</div><div class="line">        <span class="keyword">if</span> (blockLayoutRequests) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mBlockLayoutRequests = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">super</span>.layoutChildren();</div><div class="line"></div><div class="line">            invalidate();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mAdapter == <span class="keyword">null</span>) &#123;</div><div class="line">                resetList();</div><div class="line">                invokeOnItemScrollListener();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childrenTop = mListPadding.top;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childrenBottom = mBottom - mTop - mListPadding.bottom;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line"></div><div class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">            <span class="keyword">int</span> delta = <span class="number">0</span>;</div><div class="line"></div><div class="line">            View sel;</div><div class="line">            View oldSel = <span class="keyword">null</span>;</div><div class="line">            View oldFirst = <span class="keyword">null</span>;</div><div class="line">            View newSel = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">            <span class="comment">// Remember stuff we will need down below</span></div><div class="line">            <span class="keyword">switch</span> (mLayoutMode) &#123;</div><div class="line">            <span class="keyword">case</span> LAYOUT_SET_SELECTION:</div><div class="line">                index = mNextSelectedPosition - mFirstPosition;</div><div class="line">                <span class="keyword">if</span> (index &gt;= <span class="number">0</span> &amp;&amp; index &lt; childCount) &#123;</div><div class="line">                    newSel = getChildAt(index);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_FORCE_TOP:</div><div class="line">            <span class="keyword">case</span> LAYOUT_FORCE_BOTTOM:</div><div class="line">            <span class="keyword">case</span> LAYOUT_SPECIFIC:</div><div class="line">            <span class="keyword">case</span> LAYOUT_SYNC:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_MOVE_SELECTION:</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="comment">// Remember the previously selected view</span></div><div class="line">                index = mSelectedPosition - mFirstPosition;</div><div class="line">                <span class="keyword">if</span> (index &gt;= <span class="number">0</span> &amp;&amp; index &lt; childCount) &#123;</div><div class="line">                    oldSel = getChildAt(index);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Remember the previous first child</span></div><div class="line">                oldFirst = getChildAt(<span class="number">0</span>);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (mNextSelectedPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    delta = mNextSelectedPosition - mSelectedPosition;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Caution: newSel might be null</span></div><div class="line">                newSel = getChildAt(index + delta);</div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">            <span class="keyword">boolean</span> dataChanged = mDataChanged;</div><div class="line">            <span class="keyword">if</span> (dataChanged) &#123;</div><div class="line">                handleDataChanged();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Handle the empty set by removing all views that are visible</span></div><div class="line">            <span class="comment">// and calling it a day</span></div><div class="line">            <span class="keyword">if</span> (mItemCount == <span class="number">0</span>) &#123;</div><div class="line">                resetList();</div><div class="line">                invokeOnItemScrollListener();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mItemCount != mAdapter.getCount()) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The content of the adapter has changed but "</span></div><div class="line">                        + <span class="string">"ListView did not receive a notification. Make sure the content of "</span></div><div class="line">                        + <span class="string">"your adapter is not modified from a background thread, but only from "</span></div><div class="line">                        + <span class="string">"the UI thread. Make sure your adapter calls notifyDataSetChanged() "</span></div><div class="line">                        + <span class="string">"when its content changes. [in ListView("</span> + getId() + <span class="string">", "</span> + getClass()</div><div class="line">                        + <span class="string">") with Adapter("</span> + mAdapter.getClass() + <span class="string">")]"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            setSelectedPositionInt(mNextSelectedPosition);</div><div class="line"></div><div class="line">            AccessibilityNodeInfo accessibilityFocusLayoutRestoreNode = <span class="keyword">null</span>;</div><div class="line">            View accessibilityFocusLayoutRestoreView = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">int</span> accessibilityFocusPosition = INVALID_POSITION;</div><div class="line"></div><div class="line">            <span class="comment">// Remember which child, if any, had accessibility focus. This must</span></div><div class="line">            <span class="comment">// occur before recycling any views, since that will clear</span></div><div class="line">            <span class="comment">// accessibility focus.</span></div><div class="line">            <span class="keyword">final</span> ViewRootImpl viewRootImpl = getViewRootImpl();</div><div class="line">            <span class="keyword">if</span> (viewRootImpl != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> View focusHost = viewRootImpl.getAccessibilityFocusedHost();</div><div class="line">                <span class="keyword">if</span> (focusHost != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">final</span> View focusChild = getAccessibilityFocusedChild(focusHost);</div><div class="line">                    <span class="keyword">if</span> (focusChild != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">if</span> (!dataChanged || isDirectChildHeaderOrFooter(focusChild)</div><div class="line">                                || focusChild.hasTransientState() || mAdapterHasStableIds) &#123;</div><div class="line">                            <span class="comment">// The views won't be changing, so try to maintain</span></div><div class="line">                            <span class="comment">// focus on the current host and virtual view.</span></div><div class="line">                            accessibilityFocusLayoutRestoreView = focusHost;</div><div class="line">                            accessibilityFocusLayoutRestoreNode = viewRootImpl</div><div class="line">                                    .getAccessibilityFocusedVirtualView();</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="comment">// If all else fails, maintain focus at the same</span></div><div class="line">                        <span class="comment">// position.</span></div><div class="line">                        accessibilityFocusPosition = getPositionForView(focusChild);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            View focusLayoutRestoreDirectChild = <span class="keyword">null</span>;</div><div class="line">            View focusLayoutRestoreView = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">            <span class="comment">// Take focus back to us temporarily to avoid the eventual call to</span></div><div class="line">            <span class="comment">// clear focus when removing the focused child below from messing</span></div><div class="line">            <span class="comment">// things up when ViewAncestor assigns focus back to someone else.</span></div><div class="line">            <span class="keyword">final</span> View focusedChild = getFocusedChild();</div><div class="line">            <span class="keyword">if</span> (focusedChild != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// <span class="doctag">TODO:</span> in some cases focusedChild.getParent() == null</span></div><div class="line"></div><div class="line">                <span class="comment">// We can remember the focused view to restore after re-layout</span></div><div class="line">                <span class="comment">// if the data hasn't changed, or if the focused position is a</span></div><div class="line">                <span class="comment">// header or footer.</span></div><div class="line">                <span class="keyword">if</span> (!dataChanged || isDirectChildHeaderOrFooter(focusedChild)</div><div class="line">                        || focusedChild.hasTransientState() || mAdapterHasStableIds) &#123;</div><div class="line">                    focusLayoutRestoreDirectChild = focusedChild;</div><div class="line">                    <span class="comment">// Remember the specific view that had focus.</span></div><div class="line">                    focusLayoutRestoreView = findFocus();</div><div class="line">                    <span class="keyword">if</span> (focusLayoutRestoreView != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">// Tell it we are going to mess with it.</span></div><div class="line">                        focusLayoutRestoreView.dispatchStartTemporaryDetach();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                requestFocus();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Pull all children into the RecycleBin.</span></div><div class="line">            <span class="comment">// These views will be reused if possible</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> firstPosition = mFirstPosition;</div><div class="line">            <span class="keyword">final</span> RecycleBin recycleBin = mRecycler;</div><div class="line">            <span class="keyword">if</span> (dataChanged) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">                    recycleBin.addScrapView(getChildAt(i), firstPosition+i);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                recycleBin.fillActiveViews(childCount, firstPosition);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Clear out old views</span></div><div class="line">            detachAllViewsFromParent();</div><div class="line">            recycleBin.removeSkippedScrap();</div><div class="line"></div><div class="line">            <span class="keyword">switch</span> (mLayoutMode) &#123;</div><div class="line">            <span class="keyword">case</span> LAYOUT_SET_SELECTION:</div><div class="line">                <span class="keyword">if</span> (newSel != <span class="keyword">null</span>) &#123;</div><div class="line">                    sel = fillFromSelection(newSel.getTop(), childrenTop, childrenBottom);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    sel = fillFromMiddle(childrenTop, childrenBottom);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_SYNC:</div><div class="line">                sel = fillSpecific(mSyncPosition, mSpecificTop);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_FORCE_BOTTOM:</div><div class="line">                sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</div><div class="line">                adjustViewsUpOrDown();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_FORCE_TOP:</div><div class="line">                mFirstPosition = <span class="number">0</span>;</div><div class="line">                sel = fillFromTop(childrenTop);</div><div class="line">                adjustViewsUpOrDown();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_SPECIFIC:</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> selectedPosition = reconcileSelectedPosition();</div><div class="line">                sel = fillSpecific(selectedPosition, mSpecificTop);</div><div class="line">                <span class="comment">/**</span></div><div class="line">                 * When ListView is resized, FocusSelector requests an async selection for the</div><div class="line">                 * previously focused item to make sure it is still visible. If the item is not</div><div class="line">                 * selectable, it won't regain focus so instead we call FocusSelector</div><div class="line">                 * to directly request focus on the view after it is visible.</div><div class="line">                 */</div><div class="line">                <span class="keyword">if</span> (sel == <span class="keyword">null</span> &amp;&amp; mFocusSelector != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">final</span> Runnable focusRunnable = mFocusSelector</div><div class="line">                            .setupFocusIfValid(selectedPosition);</div><div class="line">                    <span class="keyword">if</span> (focusRunnable != <span class="keyword">null</span>) &#123;</div><div class="line">                        post(focusRunnable);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_MOVE_SELECTION:</div><div class="line">                sel = moveSelection(oldSel, newSel, delta, childrenTop, childrenBottom);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">if</span> (childCount == <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (!mStackFromBottom) &#123;</div><div class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> position = lookForSelectablePosition(<span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">                        setSelectedPositionInt(position);</div><div class="line">                        sel = fillFromTop(childrenTop);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> position = lookForSelectablePosition(mItemCount - <span class="number">1</span>, <span class="keyword">false</span>);</div><div class="line">                        setSelectedPositionInt(position);</div><div class="line">                        sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (mSelectedPosition &gt;= <span class="number">0</span> &amp;&amp; mSelectedPosition &lt; mItemCount) &#123;</div><div class="line">                        sel = fillSpecific(mSelectedPosition,</div><div class="line">                                oldSel == <span class="keyword">null</span> ? childrenTop : oldSel.getTop());</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFirstPosition &lt; mItemCount) &#123;</div><div class="line">                        sel = fillSpecific(mFirstPosition,</div><div class="line">                                oldFirst == <span class="keyword">null</span> ? childrenTop : oldFirst.getTop());</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        sel = fillSpecific(<span class="number">0</span>, childrenTop);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Flush any cached views that did not get reused above</span></div><div class="line">            recycleBin.scrapActiveViews();</div><div class="line"></div><div class="line">            <span class="comment">// remove any header/footer that has been temp detached and not re-attached</span></div><div class="line">            removeUnusedFixedViews(mHeaderViewInfos);</div><div class="line">            removeUnusedFixedViews(mFooterViewInfos);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (sel != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// The current selected item should get focus if items are</span></div><div class="line">                <span class="comment">// focusable.</span></div><div class="line">                <span class="keyword">if</span> (mItemsCanFocus &amp;&amp; hasFocus() &amp;&amp; !sel.hasFocus()) &#123;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> focusWasTaken = (sel == focusLayoutRestoreDirectChild &amp;&amp;</div><div class="line">                            focusLayoutRestoreView != <span class="keyword">null</span> &amp;&amp;</div><div class="line">                            focusLayoutRestoreView.requestFocus()) || sel.requestFocus();</div><div class="line">                    <span class="keyword">if</span> (!focusWasTaken) &#123;</div><div class="line">                        <span class="comment">// Selected item didn't take focus, but we still want to</span></div><div class="line">                        <span class="comment">// make sure something else outside of the selected view</span></div><div class="line">                        <span class="comment">// has focus.</span></div><div class="line">                        <span class="keyword">final</span> View focused = getFocusedChild();</div><div class="line">                        <span class="keyword">if</span> (focused != <span class="keyword">null</span>) &#123;</div><div class="line">                            focused.clearFocus();</div><div class="line">                        &#125;</div><div class="line">                        positionSelector(INVALID_POSITION, sel);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        sel.setSelected(<span class="keyword">false</span>);</div><div class="line">                        mSelectorRect.setEmpty();</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    positionSelector(INVALID_POSITION, sel);</div><div class="line">                &#125;</div><div class="line">                mSelectedTop = sel.getTop();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> inTouchMode = mTouchMode == TOUCH_MODE_TAP</div><div class="line">                        || mTouchMode == TOUCH_MODE_DONE_WAITING;</div><div class="line">                <span class="keyword">if</span> (inTouchMode) &#123;</div><div class="line">                    <span class="comment">// If the user's finger is down, select the motion position.</span></div><div class="line">                    <span class="keyword">final</span> View child = getChildAt(mMotionPosition - mFirstPosition);</div><div class="line">                    <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">                        positionSelector(mMotionPosition, child);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSelectorPosition != INVALID_POSITION) &#123;</div><div class="line">                    <span class="comment">// If we had previously positioned the selector somewhere,</span></div><div class="line">                    <span class="comment">// put it back there. It might not match up with the data,</span></div><div class="line">                    <span class="comment">// but it's transitioning out so it's not a big deal.</span></div><div class="line">                    <span class="keyword">final</span> View child = getChildAt(mSelectorPosition - mFirstPosition);</div><div class="line">                    <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">                        positionSelector(mSelectorPosition, child);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// Otherwise, clear selection.</span></div><div class="line">                    mSelectedTop = <span class="number">0</span>;</div><div class="line">                    mSelectorRect.setEmpty();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Even if there is not selected position, we may need to</span></div><div class="line">                <span class="comment">// restore focus (i.e. something focusable in touch mode).</span></div><div class="line">                <span class="keyword">if</span> (hasFocus() &amp;&amp; focusLayoutRestoreView != <span class="keyword">null</span>) &#123;</div><div class="line">                    focusLayoutRestoreView.requestFocus();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Attempt to restore accessibility focus, if necessary.</span></div><div class="line">            <span class="keyword">if</span> (viewRootImpl != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> View newAccessibilityFocusedView = viewRootImpl.getAccessibilityFocusedHost();</div><div class="line">                <span class="keyword">if</span> (newAccessibilityFocusedView == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (accessibilityFocusLayoutRestoreView != <span class="keyword">null</span></div><div class="line">                            &amp;&amp; accessibilityFocusLayoutRestoreView.isAttachedToWindow()) &#123;</div><div class="line">                        <span class="keyword">final</span> AccessibilityNodeProvider provider =</div><div class="line">                                accessibilityFocusLayoutRestoreView.getAccessibilityNodeProvider();</div><div class="line">                        <span class="keyword">if</span> (accessibilityFocusLayoutRestoreNode != <span class="keyword">null</span> &amp;&amp; provider != <span class="keyword">null</span>) &#123;</div><div class="line">                            <span class="keyword">final</span> <span class="keyword">int</span> virtualViewId = AccessibilityNodeInfo.getVirtualDescendantId(</div><div class="line">                                    accessibilityFocusLayoutRestoreNode.getSourceNodeId());</div><div class="line">                            provider.performAction(virtualViewId,</div><div class="line">                                    AccessibilityNodeInfo.ACTION_ACCESSIBILITY_FOCUS, <span class="keyword">null</span>);</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            accessibilityFocusLayoutRestoreView.requestAccessibilityFocus();</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (accessibilityFocusPosition != INVALID_POSITION) &#123;</div><div class="line">                        <span class="comment">// Bound the position within the visible children.</span></div><div class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> position = MathUtils.constrain(</div><div class="line">                                accessibilityFocusPosition - mFirstPosition, <span class="number">0</span>,</div><div class="line">                                getChildCount() - <span class="number">1</span>);</div><div class="line">                        <span class="keyword">final</span> View restoreView = getChildAt(position);</div><div class="line">                        <span class="keyword">if</span> (restoreView != <span class="keyword">null</span>) &#123;</div><div class="line">                            restoreView.requestAccessibilityFocus();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Tell focus view we are done mucking with it, if it is still in</span></div><div class="line">            <span class="comment">// our view hierarchy.</span></div><div class="line">            <span class="keyword">if</span> (focusLayoutRestoreView != <span class="keyword">null</span></div><div class="line">                    &amp;&amp; focusLayoutRestoreView.getWindowToken() != <span class="keyword">null</span>) &#123;</div><div class="line">                focusLayoutRestoreView.dispatchFinishTemporaryDetach();</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            mLayoutMode = LAYOUT_NORMAL;</div><div class="line">            mDataChanged = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (mPositionScrollAfterLayout != <span class="keyword">null</span>) &#123;</div><div class="line">                post(mPositionScrollAfterLayout);</div><div class="line">                mPositionScrollAfterLayout = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            mNeedSync = <span class="keyword">false</span>;</div><div class="line">            setNextSelectedPositionInt(mSelectedPosition);</div><div class="line"></div><div class="line">            updateScrollIndicators();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mItemCount &gt; <span class="number">0</span>) &#123;</div><div class="line">                checkSelectionChanged();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            invokeOnItemScrollListener();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (mFocusSelector != <span class="keyword">null</span>) &#123;</div><div class="line">                mFocusSelector.onLayoutComplete();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!blockLayoutRequests) &#123;</div><div class="line">                mBlockLayoutRequests = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这段代码真的很长，挑重点来说，在第12行有getChildCount()，这方法是获取当前View中有几个子View的，很显然现在为止，没有对咱们这个View进行任何添加操作，所以这里就是0了。这样我们发现一条线索，但是大家不要忘记之前我们说过的那个很重要的内部类RecycleBin,所以接下来我们在第144行发现RecycleBin，紧接着会根据dataChanged这个布尔型的值来判断执行逻辑，dataChanged只有在数据源发生改变的情况下才会变成true，其它情况都是false，因此这里会进入到第151行的执行逻辑，调用RecycleBin的fillActiveViews()方法，这个方法用来缓存当前在屏幕上显示着的View的，就目前来说，什么都没有，所有它也缓冲不成了。我们继续顺着ChildCount = 0 这条线索，在199行发现了，一个判断，我们进去里面紧接着有个判断加载布局顺序的方向，这里面有个属性是StackFromBottom，当false的时候是布局顺序是从上往下加载的。自然的我们进入<strong>fillFromTop()</strong>方法。</p>
<p>注释：<strong>Fills the list from top to bottom, starting with mFirstPosition</strong><br>从上至下，开始填充列表，并且开始的位置在<em>mFirstPosition</em><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">fillFromTop</span><span class="params">(<span class="keyword">int</span> nextTop)</span> </span>&#123;</div><div class="line">        mFirstPosition = Math.min(mFirstPosition, mSelectedPosition);</div><div class="line">        mFirstPosition = Math.min(mFirstPosition, mItemCount - <span class="number">1</span>);</div><div class="line">        <span class="keyword">if</span> (mFirstPosition &lt; <span class="number">0</span>) &#123;</div><div class="line">            mFirstPosition = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> fillDown(mFirstPosition, nextTop);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>对于传进来的数值，进行了合理性的判断，然后继续调用<strong>fillDown(mFirstPosition, nextTop)</strong>，通过这个函数的参数，它指定了加载第一个元素的位置，和下一个元素的位置，这里面我们把第二个参数可以看成标注加载方向的一个变量，分析在这里，这个方法的功能已经大致分析出来了，依然看注释</p>
<p><strong>Fills the list from pos down to the end of the list view.</strong></p>
<p>这个证明了刚才的分析是正确的，我们来看它的源码（在这里我们不可避免的要看，因为这个是我们前进的一条主线）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">fillDown</span><span class="params">(<span class="keyword">int</span> pos, <span class="keyword">int</span> nextTop)</span> </span>&#123;</div><div class="line">        View selectedView = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> end = (mBottom - mTop);</div><div class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">            end -= mListPadding.bottom;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (nextTop &lt; end &amp;&amp; pos &lt; mItemCount) &#123;</div><div class="line">            <span class="comment">// is this the selected item?</span></div><div class="line">            <span class="keyword">boolean</span> selected = pos == mSelectedPosition;</div><div class="line">            View child = makeAndAddView(pos, nextTop, <span class="keyword">true</span>, mListPadding.left, selected);</div><div class="line"></div><div class="line">            nextTop = child.getBottom() + mDividerHeight;</div><div class="line">            <span class="keyword">if</span> (selected) &#123;</div><div class="line">                selectedView = child;</div><div class="line">            &#125;</div><div class="line">            pos++;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setVisibleRangeHint(mFirstPosition, mFirstPosition + getChildCount() - <span class="number">1</span>);</div><div class="line">        <span class="keyword">return</span> selectedView;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p> 代码不多，但是我们感觉离着正确的答案越来越近了，直到现在我们依然没有看见任何在布局中添加View的代码。里面第一映入眼帘的是一个while循环，我们捎带着瞟一下上面和下面，上面是对数值的一些操作，用处不大，下面是设置一下属性内容，作用不大，看来我们的重点就在while循环里面了，首先看这个判断条件<strong>nextTop &lt; end &amp;&amp; pos &lt; mItemCount</strong>，end通过上面代码来看，应该表示能显示的最下边的像素。mItemCount，这个数据在前面被赋值了,getCount有木有很熟悉的赶脚，没错！这就是为什么继承BaseAdapter时，getCount必须进行重写，如果不重写就会认为里面没有数据，就不会加载View了，接下来，在刚才分析之中已经感觉出来了，while循环里面的就要放置View了！而且他一次性放置只放置一屏幕，不会在屏幕外也加载，就算有1000条数据，也只能一屏幕一屏幕的加载了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mItemCount = mAdapter.getCount();</div></pre></td></tr></table></figure></p>
<p>我们进入makeAndAddView(pos, nextTop, true, mListPadding.left, selected)中，第一步看注释，已经不用我说了吧~<br><strong>Obtains the view and adds it to our list of children. The view can be made fresh, converted from an unused view, or used as is if it was in the recycle bin.</strong><br>添加View并且加它到我们的list的子数据中。这个view能被刷新，并且还可以从一个不使用的View中转化过来，或者如果有的话，直接使用recycle bin里面的东西。<br>咱们之前分析的东西在里终于被重点提到了！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">makeAndAddView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flow, <span class="keyword">int</span> childrenLeft,</span></span></div><div class="line">            <span class="keyword">boolean</span> selected) &#123;</div><div class="line">        <span class="keyword">if</span> (!mDataChanged) &#123;</div><div class="line">            <span class="comment">// Try to use an existing view for this position.</span></div><div class="line">            <span class="keyword">final</span> View activeView = mRecycler.getActiveView(position);</div><div class="line">            <span class="keyword">if</span> (activeView != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// Found it. We're reusing an existing child, so it just needs</span></div><div class="line">                <span class="comment">// to be positioned like a scrap view.</span></div><div class="line">                setupChild(activeView, position, y, flow, childrenLeft, selected, <span class="keyword">true</span>);</div><div class="line">                <span class="keyword">return</span> activeView;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Make a new view for this position, or convert an unused view if</span></div><div class="line">        <span class="comment">// possible.</span></div><div class="line">        <span class="keyword">final</span> View child = obtainView(position, mIsScrap);</div><div class="line"></div><div class="line">        <span class="comment">// This needs to be positioned and measured.</span></div><div class="line">        setupChild(child, position, y, flow, childrenLeft, selected, mIsScrap[<span class="number">0</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> child;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>在第3行判断数据是否改变，当然false啦！紧接着尝试从RecycleBin当中快速获取一个active view，不过我们目前没有对RecycleBin进行存值操作，所以得到的是null，我们继续往下，到了第16行，上面的注释写着，会在这个位置上面生成一个新View，或者可能转换一个不使用的View。</p>
<p>这个函数在ListView中找不到，在AbsListView中~<br><strong>Gets a view and have it show the data associated with the specified<br>position. This is called when we have already discovered that the view<br>is not available for reuse in the recycle bin. The only choices left are<br>converting an old view or making a new one.</strong></p>
<p>得到一个View并且让他在指定位置上展示数据，这个函数会在我们已经发现这个View不能从RecycleBin直接获得，这个接下唯一的选择就是转换一个老View或者造一个新的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="function">View <span class="title">obtainView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">boolean</span>[] outMetadata)</span> </span>&#123;</div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"obtainView"</span>);</div><div class="line"></div><div class="line">        outMetadata[<span class="number">0</span>] = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Check whether we have a transient state view. Attempt to re-bind the</span></div><div class="line">        <span class="comment">// data and discard the view if we fail.</span></div><div class="line">        <span class="keyword">final</span> View transientView = mRecycler.getTransientStateView(position);</div><div class="line">        <span class="keyword">if</span> (transientView != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> LayoutParams params = (LayoutParams) transientView.getLayoutParams();</div><div class="line"></div><div class="line">            <span class="comment">// If the view type hasn't changed, attempt to re-bind the data.</span></div><div class="line">            <span class="keyword">if</span> (params.viewType == mAdapter.getItemViewType(position)) &#123;</div><div class="line">                <span class="keyword">final</span> View updatedView = mAdapter.getView(position, transientView, <span class="keyword">this</span>);</div><div class="line"></div><div class="line">                <span class="comment">// If we failed to re-bind the data, scrap the obtained view.</span></div><div class="line">                <span class="keyword">if</span> (updatedView != transientView) &#123;</div><div class="line">                    setItemViewLayoutParams(updatedView, position);</div><div class="line">                    mRecycler.addScrapView(updatedView, position);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            outMetadata[<span class="number">0</span>] = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">            <span class="comment">// Finish the temporary detach started in addScrapView().</span></div><div class="line">            transientView.dispatchFinishTemporaryDetach();</div><div class="line">            <span class="keyword">return</span> transientView;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> View scrapView = mRecycler.getScrapView(position);</div><div class="line">        <span class="keyword">final</span> View child = mAdapter.getView(position, scrapView, <span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> (scrapView != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (child != scrapView) &#123;</div><div class="line">                <span class="comment">// Failed to re-bind the data, return scrap to the heap.</span></div><div class="line">                mRecycler.addScrapView(scrapView, position);</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.isTemporarilyDetached()) &#123;</div><div class="line">                outMetadata[<span class="number">0</span>] = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">                <span class="comment">// Finish the temporary detach started in addScrapView().</span></div><div class="line">                child.dispatchFinishTemporaryDetach();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mCacheColorHint != <span class="number">0</span>) &#123;</div><div class="line">            child.setDrawingCacheBackgroundColor(mCacheColorHint);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (child.getImportantForAccessibility() == IMPORTANT_FOR_ACCESSIBILITY_AUTO) &#123;</div><div class="line">            child.setImportantForAccessibility(IMPORTANT_FOR_ACCESSIBILITY_YES);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setItemViewLayoutParams(child, position);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (AccessibilityManager.getInstance(mContext).isEnabled()) &#123;</div><div class="line">            <span class="keyword">if</span> (mAccessibilityDelegate == <span class="keyword">null</span>) &#123;</div><div class="line">                mAccessibilityDelegate = <span class="keyword">new</span> ListItemAccessibilityDelegate();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (child.getAccessibilityDelegate() == <span class="keyword">null</span>) &#123;</div><div class="line">                child.setAccessibilityDelegate(mAccessibilityDelegate);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> child;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>我们会看到在第30行，他尝试这从ScrapView中获取一个，回答同样是不可以的，因为这个没有数据，我们第31行看见了，我们的adapter.getView（），这个方法我们很熟悉，我们会返回一个我们已经准备好的item，返回也是return child；</p>
<p>这个方法执行完了，我们回到makeAndAddView（），继续向下执行第19行。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">makeAndAddView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flow, <span class="keyword">int</span> childrenLeft,</span></span></div><div class="line">            <span class="keyword">boolean</span> selected) &#123;</div><div class="line">        <span class="keyword">if</span> (!mDataChanged) &#123;</div><div class="line">            <span class="comment">// Try to use an existing view for this position.</span></div><div class="line">            <span class="keyword">final</span> View activeView = mRecycler.getActiveView(position);</div><div class="line">            <span class="keyword">if</span> (activeView != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// Found it. We're reusing an existing child, so it just needs</span></div><div class="line">                <span class="comment">// to be positioned like a scrap view.</span></div><div class="line">                setupChild(activeView, position, y, flow, childrenLeft, selected, <span class="keyword">true</span>);</div><div class="line">                <span class="keyword">return</span> activeView;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Make a new view for this position, or convert an unused view if</span></div><div class="line">        <span class="comment">// possible.</span></div><div class="line">        <span class="keyword">final</span> View child = obtainView(position, mIsScrap);</div><div class="line"></div><div class="line">        <span class="comment">// This needs to be positioned and measured.</span></div><div class="line">        setupChild(child, position, y, flow, childrenLeft, selected, mIsScrap[<span class="number">0</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> child;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>在第19行会调用setupChild()，忽略参数问题，光看方法名字——安装Child，看来这个方法里面将会放置View！</p>
<p><strong>Adds a view as a child and make sure it is measured (if necessary) and<br>positioned properly.</strong></p>
<p>感觉不用我再翻译了，作为child添加一个View看来结论就是在这个地方设置了View啊！！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupChild</span><span class="params">(View child, <span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flowDown, <span class="keyword">int</span> childrenLeft,</span></span></div><div class="line">            <span class="keyword">boolean</span> selected, <span class="keyword">boolean</span> isAttachedToWindow) &#123;</div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"setupListItem"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isSelected = selected &amp;&amp; shouldShowSelector();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> updateChildSelected = isSelected != child.isSelected();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> mode = mTouchMode;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isPressed = mode &gt; TOUCH_MODE_DOWN &amp;&amp; mode &lt; TOUCH_MODE_SCROLL</div><div class="line">                &amp;&amp; mMotionPosition == position;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> updateChildPressed = isPressed != child.isPressed();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> needToMeasure = !isAttachedToWindow || updateChildSelected</div><div class="line">                || child.isLayoutRequested();</div><div class="line"></div><div class="line">        <span class="comment">// Respect layout params that are already in the view. Otherwise make</span></div><div class="line">        <span class="comment">// some up...</span></div><div class="line">        AbsListView.LayoutParams p = (AbsListView.LayoutParams) child.getLayoutParams();</div><div class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">            p = (AbsListView.LayoutParams) generateDefaultLayoutParams();</div><div class="line">        &#125;</div><div class="line">        p.viewType = mAdapter.getItemViewType(position);</div><div class="line">        p.isEnabled = mAdapter.isEnabled(position);</div><div class="line"></div><div class="line">        <span class="comment">// Set up view state before attaching the view, since we may need to</span></div><div class="line">        <span class="comment">// rely on the jumpDrawablesToCurrentState() call that occurs as part</span></div><div class="line">        <span class="comment">// of view attachment.</span></div><div class="line">        <span class="keyword">if</span> (updateChildSelected) &#123;</div><div class="line">            child.setSelected(isSelected);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (updateChildPressed) &#123;</div><div class="line">            child.setPressed(isPressed);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mChoiceMode != CHOICE_MODE_NONE &amp;&amp; mCheckStates != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (child <span class="keyword">instanceof</span> Checkable) &#123;</div><div class="line">                ((Checkable) child).setChecked(mCheckStates.get(position));</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getContext().getApplicationInfo().targetSdkVersion</div><div class="line">                    &gt;= android.os.Build.VERSION_CODES.HONEYCOMB) &#123;</div><div class="line">                child.setActivated(mCheckStates.get(position));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ((isAttachedToWindow &amp;&amp; !p.forceAdd) || (p.recycledHeaderFooter</div><div class="line">                &amp;&amp; p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER)) &#123;</div><div class="line">            attachViewToParent(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p);</div><div class="line"></div><div class="line">            <span class="comment">// If the view was previously attached for a different position,</span></div><div class="line">            <span class="comment">// then manually jump the drawables.</span></div><div class="line">            <span class="keyword">if</span> (isAttachedToWindow</div><div class="line">                    &amp;&amp; (((AbsListView.LayoutParams) child.getLayoutParams()).scrappedFromPosition)</div><div class="line">                            != position) &#123;</div><div class="line">                child.jumpDrawablesToCurrentState();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            p.forceAdd = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">                p.recycledHeaderFooter = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            addViewInLayout(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p, <span class="keyword">true</span>);</div><div class="line">            <span class="comment">// add view in layout will reset the RTL properties. We have to re-resolve them</span></div><div class="line">            child.resolveRtlPropertiesIfNeeded();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (needToMeasure) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childWidthSpec = ViewGroup.getChildMeasureSpec(mWidthMeasureSpec,</div><div class="line">                    mListPadding.left + mListPadding.right, p.width);</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> lpHeight = p.height;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childHeightSpec;</div><div class="line">            <span class="keyword">if</span> (lpHeight &gt; <span class="number">0</span>) &#123;</div><div class="line">                childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight, MeasureSpec.EXACTLY);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                childHeightSpec = MeasureSpec.makeSafeMeasureSpec(getMeasuredHeight(),</div><div class="line">                        MeasureSpec.UNSPECIFIED);</div><div class="line">            &#125;</div><div class="line">            child.measure(childWidthSpec, childHeightSpec);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            cleanupLayoutState(child);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> w = child.getMeasuredWidth();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> h = child.getMeasuredHeight();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childTop = flowDown ? y : y - h;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (needToMeasure) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childRight = childrenLeft + w;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childBottom = childTop + h;</div><div class="line">            child.layout(childrenLeft, childTop, childRight, childBottom);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            child.offsetLeftAndRight(childrenLeft - child.getLeft());</div><div class="line">            child.offsetTopAndBottom(childTop - child.getTop());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mCachingStarted &amp;&amp; !child.isDrawingCacheEnabled()) &#123;</div><div class="line">            child.setDrawingCacheEnabled(<span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>代码依然很多，但是我们这里只说重点!在第59行出现了一个方法addViewInLayout(child, flowDown ? -1 : 0, p, true);看函数名，就知道了。到目前为止我们的layout上面已经有View了。</p>
<p>咱们的第一次layout终于完毕！</p>
<h2 id="第二次Layout"><a href="#第二次Layout" class="headerlink" title="第二次Layout"></a>第二次Layout</h2><p>即使是一个再简单的View，在展示到界面上之前都会经历至少两次onMeasure()和两次onLayout()的过程。其实这只是一个很小的细节，平时对我们影响并不大，因为不管是onMeasure()或者onLayout()几次，反正都是执行的相同的逻辑，我们并不需要进行过多关心。但是在ListView中情况就不一样了，因为这就意味着layoutChildren()过程会执行两次，而这个过程当中涉及到向ListView中添加子元素，如果相同的逻辑执行两遍的话，那么ListView中就会存在一份重复的数据了。因此ListView在layoutChildren()过程当中做了第二次Layout的逻辑处理，非常巧妙地解决了这个问题，下面我们就来分析一下第二次Layout的过程。</p>
<p>时间直接进入layoutChildren()，因为OnLayout里面几乎什么都没有。<br>第一次和第二次的流程其实差不多，不过具体细节就有所不同了~<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> blockLayoutRequests = mBlockLayoutRequests;</div><div class="line">        <span class="keyword">if</span> (blockLayoutRequests) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mBlockLayoutRequests = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">super</span>.layoutChildren();</div><div class="line"></div><div class="line">            invalidate();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mAdapter == <span class="keyword">null</span>) &#123;</div><div class="line">                resetList();</div><div class="line">                invokeOnItemScrollListener();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childrenTop = mListPadding.top;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childrenBottom = mBottom - mTop - mListPadding.bottom;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line"></div><div class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line">            <span class="keyword">int</span> delta = <span class="number">0</span>;</div><div class="line"></div><div class="line">            View sel;</div><div class="line">            View oldSel = <span class="keyword">null</span>;</div><div class="line">            View oldFirst = <span class="keyword">null</span>;</div><div class="line">            View newSel = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">            <span class="comment">// Remember stuff we will need down below</span></div><div class="line">            <span class="keyword">switch</span> (mLayoutMode) &#123;</div><div class="line">            <span class="keyword">case</span> LAYOUT_SET_SELECTION:</div><div class="line">                index = mNextSelectedPosition - mFirstPosition;</div><div class="line">                <span class="keyword">if</span> (index &gt;= <span class="number">0</span> &amp;&amp; index &lt; childCount) &#123;</div><div class="line">                    newSel = getChildAt(index);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_FORCE_TOP:</div><div class="line">            <span class="keyword">case</span> LAYOUT_FORCE_BOTTOM:</div><div class="line">            <span class="keyword">case</span> LAYOUT_SPECIFIC:</div><div class="line">            <span class="keyword">case</span> LAYOUT_SYNC:</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_MOVE_SELECTION:</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="comment">// Remember the previously selected view</span></div><div class="line">                index = mSelectedPosition - mFirstPosition;</div><div class="line">                <span class="keyword">if</span> (index &gt;= <span class="number">0</span> &amp;&amp; index &lt; childCount) &#123;</div><div class="line">                    oldSel = getChildAt(index);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Remember the previous first child</span></div><div class="line">                oldFirst = getChildAt(<span class="number">0</span>);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (mNextSelectedPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    delta = mNextSelectedPosition - mSelectedPosition;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Caution: newSel might be null</span></div><div class="line">                newSel = getChildAt(index + delta);</div><div class="line">            &#125;</div><div class="line"></div><div class="line"></div><div class="line">            <span class="keyword">boolean</span> dataChanged = mDataChanged;</div><div class="line">            <span class="keyword">if</span> (dataChanged) &#123;</div><div class="line">                handleDataChanged();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Handle the empty set by removing all views that are visible</span></div><div class="line">            <span class="comment">// and calling it a day</span></div><div class="line">            <span class="keyword">if</span> (mItemCount == <span class="number">0</span>) &#123;</div><div class="line">                resetList();</div><div class="line">                invokeOnItemScrollListener();</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mItemCount != mAdapter.getCount()) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The content of the adapter has changed but "</span></div><div class="line">                        + <span class="string">"ListView did not receive a notification. Make sure the content of "</span></div><div class="line">                        + <span class="string">"your adapter is not modified from a background thread, but only from "</span></div><div class="line">                        + <span class="string">"the UI thread. Make sure your adapter calls notifyDataSetChanged() "</span></div><div class="line">                        + <span class="string">"when its content changes. [in ListView("</span> + getId() + <span class="string">", "</span> + getClass()</div><div class="line">                        + <span class="string">") with Adapter("</span> + mAdapter.getClass() + <span class="string">")]"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            setSelectedPositionInt(mNextSelectedPosition);</div><div class="line"></div><div class="line">            AccessibilityNodeInfo accessibilityFocusLayoutRestoreNode = <span class="keyword">null</span>;</div><div class="line">            View accessibilityFocusLayoutRestoreView = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">int</span> accessibilityFocusPosition = INVALID_POSITION;</div><div class="line"></div><div class="line">            <span class="comment">// Remember which child, if any, had accessibility focus. This must</span></div><div class="line">            <span class="comment">// occur before recycling any views, since that will clear</span></div><div class="line">            <span class="comment">// accessibility focus.</span></div><div class="line">            <span class="keyword">final</span> ViewRootImpl viewRootImpl = getViewRootImpl();</div><div class="line">            <span class="keyword">if</span> (viewRootImpl != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> View focusHost = viewRootImpl.getAccessibilityFocusedHost();</div><div class="line">                <span class="keyword">if</span> (focusHost != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">final</span> View focusChild = getAccessibilityFocusedChild(focusHost);</div><div class="line">                    <span class="keyword">if</span> (focusChild != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">if</span> (!dataChanged || isDirectChildHeaderOrFooter(focusChild)</div><div class="line">                                || focusChild.hasTransientState() || mAdapterHasStableIds) &#123;</div><div class="line">                            <span class="comment">// The views won't be changing, so try to maintain</span></div><div class="line">                            <span class="comment">// focus on the current host and virtual view.</span></div><div class="line">                            accessibilityFocusLayoutRestoreView = focusHost;</div><div class="line">                            accessibilityFocusLayoutRestoreNode = viewRootImpl</div><div class="line">                                    .getAccessibilityFocusedVirtualView();</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="comment">// If all else fails, maintain focus at the same</span></div><div class="line">                        <span class="comment">// position.</span></div><div class="line">                        accessibilityFocusPosition = getPositionForView(focusChild);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            View focusLayoutRestoreDirectChild = <span class="keyword">null</span>;</div><div class="line">            View focusLayoutRestoreView = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">            <span class="comment">// Take focus back to us temporarily to avoid the eventual call to</span></div><div class="line">            <span class="comment">// clear focus when removing the focused child below from messing</span></div><div class="line">            <span class="comment">// things up when ViewAncestor assigns focus back to someone else.</span></div><div class="line">            <span class="keyword">final</span> View focusedChild = getFocusedChild();</div><div class="line">            <span class="keyword">if</span> (focusedChild != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// <span class="doctag">TODO:</span> in some cases focusedChild.getParent() == null</span></div><div class="line"></div><div class="line">                <span class="comment">// We can remember the focused view to restore after re-layout</span></div><div class="line">                <span class="comment">// if the data hasn't changed, or if the focused position is a</span></div><div class="line">                <span class="comment">// header or footer.</span></div><div class="line">                <span class="keyword">if</span> (!dataChanged || isDirectChildHeaderOrFooter(focusedChild)</div><div class="line">                        || focusedChild.hasTransientState() || mAdapterHasStableIds) &#123;</div><div class="line">                    focusLayoutRestoreDirectChild = focusedChild;</div><div class="line">                    <span class="comment">// Remember the specific view that had focus.</span></div><div class="line">                    focusLayoutRestoreView = findFocus();</div><div class="line">                    <span class="keyword">if</span> (focusLayoutRestoreView != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="comment">// Tell it we are going to mess with it.</span></div><div class="line">                        focusLayoutRestoreView.dispatchStartTemporaryDetach();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                requestFocus();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Pull all children into the RecycleBin.</span></div><div class="line">            <span class="comment">// These views will be reused if possible</span></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> firstPosition = mFirstPosition;</div><div class="line">            <span class="keyword">final</span> RecycleBin recycleBin = mRecycler;</div><div class="line">            <span class="keyword">if</span> (dataChanged) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">                    recycleBin.addScrapView(getChildAt(i), firstPosition+i);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                recycleBin.fillActiveViews(childCount, firstPosition);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Clear out old views</span></div><div class="line">            detachAllViewsFromParent();</div><div class="line">            recycleBin.removeSkippedScrap();</div><div class="line"></div><div class="line">            <span class="keyword">switch</span> (mLayoutMode) &#123;</div><div class="line">            <span class="keyword">case</span> LAYOUT_SET_SELECTION:</div><div class="line">                <span class="keyword">if</span> (newSel != <span class="keyword">null</span>) &#123;</div><div class="line">                    sel = fillFromSelection(newSel.getTop(), childrenTop, childrenBottom);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    sel = fillFromMiddle(childrenTop, childrenBottom);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_SYNC:</div><div class="line">                sel = fillSpecific(mSyncPosition, mSpecificTop);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_FORCE_BOTTOM:</div><div class="line">                sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</div><div class="line">                adjustViewsUpOrDown();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_FORCE_TOP:</div><div class="line">                mFirstPosition = <span class="number">0</span>;</div><div class="line">                sel = fillFromTop(childrenTop);</div><div class="line">                adjustViewsUpOrDown();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_SPECIFIC:</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> selectedPosition = reconcileSelectedPosition();</div><div class="line">                sel = fillSpecific(selectedPosition, mSpecificTop);</div><div class="line">                <span class="comment">/**</span></div><div class="line">                 * When ListView is resized, FocusSelector requests an async selection for the</div><div class="line">                 * previously focused item to make sure it is still visible. If the item is not</div><div class="line">                 * selectable, it won't regain focus so instead we call FocusSelector</div><div class="line">                 * to directly request focus on the view after it is visible.</div><div class="line">                 */</div><div class="line">                <span class="keyword">if</span> (sel == <span class="keyword">null</span> &amp;&amp; mFocusSelector != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">final</span> Runnable focusRunnable = mFocusSelector</div><div class="line">                            .setupFocusIfValid(selectedPosition);</div><div class="line">                    <span class="keyword">if</span> (focusRunnable != <span class="keyword">null</span>) &#123;</div><div class="line">                        post(focusRunnable);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_MOVE_SELECTION:</div><div class="line">                sel = moveSelection(oldSel, newSel, delta, childrenTop, childrenBottom);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="keyword">if</span> (childCount == <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (!mStackFromBottom) &#123;</div><div class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> position = lookForSelectablePosition(<span class="number">0</span>, <span class="keyword">true</span>);</div><div class="line">                        setSelectedPositionInt(position);</div><div class="line">                        sel = fillFromTop(childrenTop);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> position = lookForSelectablePosition(mItemCount - <span class="number">1</span>, <span class="keyword">false</span>);</div><div class="line">                        setSelectedPositionInt(position);</div><div class="line">                        sel = fillUp(mItemCount - <span class="number">1</span>, childrenBottom);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (mSelectedPosition &gt;= <span class="number">0</span> &amp;&amp; mSelectedPosition &lt; mItemCount) &#123;</div><div class="line">                        sel = fillSpecific(mSelectedPosition,</div><div class="line">                                oldSel == <span class="keyword">null</span> ? childrenTop : oldSel.getTop());</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFirstPosition &lt; mItemCount) &#123;</div><div class="line">                        sel = fillSpecific(mFirstPosition,</div><div class="line">                                oldFirst == <span class="keyword">null</span> ? childrenTop : oldFirst.getTop());</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        sel = fillSpecific(<span class="number">0</span>, childrenTop);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Flush any cached views that did not get reused above</span></div><div class="line">            recycleBin.scrapActiveViews();</div><div class="line"></div><div class="line">            <span class="comment">// remove any header/footer that has been temp detached and not re-attached</span></div><div class="line">            removeUnusedFixedViews(mHeaderViewInfos);</div><div class="line">            removeUnusedFixedViews(mFooterViewInfos);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (sel != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// The current selected item should get focus if items are</span></div><div class="line">                <span class="comment">// focusable.</span></div><div class="line">                <span class="keyword">if</span> (mItemsCanFocus &amp;&amp; hasFocus() &amp;&amp; !sel.hasFocus()) &#123;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> focusWasTaken = (sel == focusLayoutRestoreDirectChild &amp;&amp;</div><div class="line">                            focusLayoutRestoreView != <span class="keyword">null</span> &amp;&amp;</div><div class="line">                            focusLayoutRestoreView.requestFocus()) || sel.requestFocus();</div><div class="line">                    <span class="keyword">if</span> (!focusWasTaken) &#123;</div><div class="line">                        <span class="comment">// Selected item didn't take focus, but we still want to</span></div><div class="line">                        <span class="comment">// make sure something else outside of the selected view</span></div><div class="line">                        <span class="comment">// has focus.</span></div><div class="line">                        <span class="keyword">final</span> View focused = getFocusedChild();</div><div class="line">                        <span class="keyword">if</span> (focused != <span class="keyword">null</span>) &#123;</div><div class="line">                            focused.clearFocus();</div><div class="line">                        &#125;</div><div class="line">                        positionSelector(INVALID_POSITION, sel);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        sel.setSelected(<span class="keyword">false</span>);</div><div class="line">                        mSelectorRect.setEmpty();</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    positionSelector(INVALID_POSITION, sel);</div><div class="line">                &#125;</div><div class="line">                mSelectedTop = sel.getTop();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> inTouchMode = mTouchMode == TOUCH_MODE_TAP</div><div class="line">                        || mTouchMode == TOUCH_MODE_DONE_WAITING;</div><div class="line">                <span class="keyword">if</span> (inTouchMode) &#123;</div><div class="line">                    <span class="comment">// If the user's finger is down, select the motion position.</span></div><div class="line">                    <span class="keyword">final</span> View child = getChildAt(mMotionPosition - mFirstPosition);</div><div class="line">                    <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">                        positionSelector(mMotionPosition, child);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSelectorPosition != INVALID_POSITION) &#123;</div><div class="line">                    <span class="comment">// If we had previously positioned the selector somewhere,</span></div><div class="line">                    <span class="comment">// put it back there. It might not match up with the data,</span></div><div class="line">                    <span class="comment">// but it's transitioning out so it's not a big deal.</span></div><div class="line">                    <span class="keyword">final</span> View child = getChildAt(mSelectorPosition - mFirstPosition);</div><div class="line">                    <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;</div><div class="line">                        positionSelector(mSelectorPosition, child);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// Otherwise, clear selection.</span></div><div class="line">                    mSelectedTop = <span class="number">0</span>;</div><div class="line">                    mSelectorRect.setEmpty();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Even if there is not selected position, we may need to</span></div><div class="line">                <span class="comment">// restore focus (i.e. something focusable in touch mode).</span></div><div class="line">                <span class="keyword">if</span> (hasFocus() &amp;&amp; focusLayoutRestoreView != <span class="keyword">null</span>) &#123;</div><div class="line">                    focusLayoutRestoreView.requestFocus();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Attempt to restore accessibility focus, if necessary.</span></div><div class="line">            <span class="keyword">if</span> (viewRootImpl != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> View newAccessibilityFocusedView = viewRootImpl.getAccessibilityFocusedHost();</div><div class="line">                <span class="keyword">if</span> (newAccessibilityFocusedView == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (accessibilityFocusLayoutRestoreView != <span class="keyword">null</span></div><div class="line">                            &amp;&amp; accessibilityFocusLayoutRestoreView.isAttachedToWindow()) &#123;</div><div class="line">                        <span class="keyword">final</span> AccessibilityNodeProvider provider =</div><div class="line">                                accessibilityFocusLayoutRestoreView.getAccessibilityNodeProvider();</div><div class="line">                        <span class="keyword">if</span> (accessibilityFocusLayoutRestoreNode != <span class="keyword">null</span> &amp;&amp; provider != <span class="keyword">null</span>) &#123;</div><div class="line">                            <span class="keyword">final</span> <span class="keyword">int</span> virtualViewId = AccessibilityNodeInfo.getVirtualDescendantId(</div><div class="line">                                    accessibilityFocusLayoutRestoreNode.getSourceNodeId());</div><div class="line">                            provider.performAction(virtualViewId,</div><div class="line">                                    AccessibilityNodeInfo.ACTION_ACCESSIBILITY_FOCUS, <span class="keyword">null</span>);</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            accessibilityFocusLayoutRestoreView.requestAccessibilityFocus();</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (accessibilityFocusPosition != INVALID_POSITION) &#123;</div><div class="line">                        <span class="comment">// Bound the position within the visible children.</span></div><div class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> position = MathUtils.constrain(</div><div class="line">                                accessibilityFocusPosition - mFirstPosition, <span class="number">0</span>,</div><div class="line">                                getChildCount() - <span class="number">1</span>);</div><div class="line">                        <span class="keyword">final</span> View restoreView = getChildAt(position);</div><div class="line">                        <span class="keyword">if</span> (restoreView != <span class="keyword">null</span>) &#123;</div><div class="line">                            restoreView.requestAccessibilityFocus();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Tell focus view we are done mucking with it, if it is still in</span></div><div class="line">            <span class="comment">// our view hierarchy.</span></div><div class="line">            <span class="keyword">if</span> (focusLayoutRestoreView != <span class="keyword">null</span></div><div class="line">                    &amp;&amp; focusLayoutRestoreView.getWindowToken() != <span class="keyword">null</span>) &#123;</div><div class="line">                focusLayoutRestoreView.dispatchFinishTemporaryDetach();</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            mLayoutMode = LAYOUT_NORMAL;</div><div class="line">            mDataChanged = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (mPositionScrollAfterLayout != <span class="keyword">null</span>) &#123;</div><div class="line">                post(mPositionScrollAfterLayout);</div><div class="line">                mPositionScrollAfterLayout = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            mNeedSync = <span class="keyword">false</span>;</div><div class="line">            setNextSelectedPositionInt(mSelectedPosition);</div><div class="line"></div><div class="line">            updateScrollIndicators();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mItemCount &gt; <span class="number">0</span>) &#123;</div><div class="line">                checkSelectionChanged();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            invokeOnItemScrollListener();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (mFocusSelector != <span class="keyword">null</span>) &#123;</div><div class="line">                mFocusSelector.onLayoutComplete();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!blockLayoutRequests) &#123;</div><div class="line">                mBlockLayoutRequests = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>依然是在第22行，调用getChildCount()方法来获取子View的数量，只不过现在得到的值不会再是0了，而是ListView中的View数量，下面在第151行调用了RecycleBin的fillActiveViews()方法，这次效果可就不一样了，因为目前ListView中已经有子View了，这样所有的子View都会被缓存到RecycleBin的mActiveViews数组当中，后面将会使用到他们。</p>
<p>紧接着在第155行执行这个方法detachAllViewsFromParent();要知道这个方法在第一次layout中同样执行了，不过因为当是ListView中没有任何View所以这个方法和没执行一样。但是要知道现在我们屏幕上已经有了View。我们开看看这个方法的作用，这个方法会将所有ListView当中的子View全部清除掉，从而保证第二次Layout过程不会产生一份重复的数据。可能会问了，这样把已经加载好的View又清除掉，待会还要再重新加载一遍，这不是严重影响效率吗？不用担心，还记得我们刚刚调用了RecycleBin的fillActiveViews()方法来缓存子View吗，待会儿将会直接使用这些缓存好的View来进行加载，而并不会重新执行一遍inflate过程，因此效率方面并不会有什么明显的影响。</p>
<p>接下拉到了199行，现在我们的childCount 已经不是0，所以我们进入else的逻辑里面，执行fillSpecific（）方法<br>注释：<br><strong>Put a specific item at a specific location on the screen and then build<br>up and down from there.</strong><br>放置一个指定item在屏幕上的指定位置，然后从这个位置的上下开始构建其他的view.</p>
<p>接下来会进入到我们熟悉的fillDown（）中，然后会进入makeAndAddView（），不过这次我们来看一下，具体逻辑是什么样的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">makeAndAddView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flow, <span class="keyword">int</span> childrenLeft,</span></span></div><div class="line">            <span class="keyword">boolean</span> selected) &#123;</div><div class="line">        <span class="keyword">if</span> (!mDataChanged) &#123;</div><div class="line">            <span class="comment">// Try to use an existing view for this position.</span></div><div class="line">            <span class="keyword">final</span> View activeView = mRecycler.getActiveView(position);</div><div class="line">            <span class="keyword">if</span> (activeView != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// Found it. We're reusing an existing child, so it just needs</span></div><div class="line">                <span class="comment">// to be positioned like a scrap view.</span></div><div class="line">                setupChild(activeView, position, y, flow, childrenLeft, selected, <span class="keyword">true</span>);</div><div class="line">                <span class="keyword">return</span> activeView;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Make a new view for this position, or convert an unused view if</span></div><div class="line">        <span class="comment">// possible.</span></div><div class="line">        <span class="keyword">final</span> View child = obtainView(position, mIsScrap);</div><div class="line"></div><div class="line">        <span class="comment">// This needs to be positioned and measured.</span></div><div class="line">        setupChild(child, position, y, flow, childrenLeft, selected, mIsScrap[<span class="number">0</span>]);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> child;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>在第5行中我们会尝试着回去一个ActiveView，当然我们现在是可以获取到的，我们不会向下走到16行，而是直接走setupChild(activeView, position, y, flow, childrenLeft, selected, true)方法中，这里注意了，最后一个元素是true，这个参数表明当前的View是之前被回收过的，我们进入这个方法中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setupChild</span><span class="params">(View child, <span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flowDown, <span class="keyword">int</span> childrenLeft,</span></span></div><div class="line">            <span class="keyword">boolean</span> selected, <span class="keyword">boolean</span> isAttachedToWindow) &#123;</div><div class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"setupListItem"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isSelected = selected &amp;&amp; shouldShowSelector();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> updateChildSelected = isSelected != child.isSelected();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> mode = mTouchMode;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isPressed = mode &gt; TOUCH_MODE_DOWN &amp;&amp; mode &lt; TOUCH_MODE_SCROLL</div><div class="line">                &amp;&amp; mMotionPosition == position;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> updateChildPressed = isPressed != child.isPressed();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> needToMeasure = !isAttachedToWindow || updateChildSelected</div><div class="line">                || child.isLayoutRequested();</div><div class="line"></div><div class="line">        <span class="comment">// Respect layout params that are already in the view. Otherwise make</span></div><div class="line">        <span class="comment">// some up...</span></div><div class="line">        AbsListView.LayoutParams p = (AbsListView.LayoutParams) child.getLayoutParams();</div><div class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</div><div class="line">            p = (AbsListView.LayoutParams) generateDefaultLayoutParams();</div><div class="line">        &#125;</div><div class="line">        p.viewType = mAdapter.getItemViewType(position);</div><div class="line">        p.isEnabled = mAdapter.isEnabled(position);</div><div class="line"></div><div class="line">        <span class="comment">// Set up view state before attaching the view, since we may need to</span></div><div class="line">        <span class="comment">// rely on the jumpDrawablesToCurrentState() call that occurs as part</span></div><div class="line">        <span class="comment">// of view attachment.</span></div><div class="line">        <span class="keyword">if</span> (updateChildSelected) &#123;</div><div class="line">            child.setSelected(isSelected);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (updateChildPressed) &#123;</div><div class="line">            child.setPressed(isPressed);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mChoiceMode != CHOICE_MODE_NONE &amp;&amp; mCheckStates != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (child <span class="keyword">instanceof</span> Checkable) &#123;</div><div class="line">                ((Checkable) child).setChecked(mCheckStates.get(position));</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getContext().getApplicationInfo().targetSdkVersion</div><div class="line">                    &gt;= android.os.Build.VERSION_CODES.HONEYCOMB) &#123;</div><div class="line">                child.setActivated(mCheckStates.get(position));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ((isAttachedToWindow &amp;&amp; !p.forceAdd) || (p.recycledHeaderFooter</div><div class="line">                &amp;&amp; p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER)) &#123;</div><div class="line">            attachViewToParent(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p);</div><div class="line"></div><div class="line">            <span class="comment">// If the view was previously attached for a different position,</span></div><div class="line">            <span class="comment">// then manually jump the drawables.</span></div><div class="line">            <span class="keyword">if</span> (isAttachedToWindow</div><div class="line">                    &amp;&amp; (((AbsListView.LayoutParams) child.getLayoutParams()).scrappedFromPosition)</div><div class="line">                            != position) &#123;</div><div class="line">                child.jumpDrawablesToCurrentState();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            p.forceAdd = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (p.viewType == AdapterView.ITEM_VIEW_TYPE_HEADER_OR_FOOTER) &#123;</div><div class="line">                p.recycledHeaderFooter = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            addViewInLayout(child, flowDown ? -<span class="number">1</span> : <span class="number">0</span>, p, <span class="keyword">true</span>);</div><div class="line">            <span class="comment">// add view in layout will reset the RTL properties. We have to re-resolve them</span></div><div class="line">            child.resolveRtlPropertiesIfNeeded();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (needToMeasure) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childWidthSpec = ViewGroup.getChildMeasureSpec(mWidthMeasureSpec,</div><div class="line">                    mListPadding.left + mListPadding.right, p.width);</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> lpHeight = p.height;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childHeightSpec;</div><div class="line">            <span class="keyword">if</span> (lpHeight &gt; <span class="number">0</span>) &#123;</div><div class="line">                childHeightSpec = MeasureSpec.makeMeasureSpec(lpHeight, MeasureSpec.EXACTLY);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                childHeightSpec = MeasureSpec.makeSafeMeasureSpec(getMeasuredHeight(),</div><div class="line">                        MeasureSpec.UNSPECIFIED);</div><div class="line">            &#125;</div><div class="line">            child.measure(childWidthSpec, childHeightSpec);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            cleanupLayoutState(child);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> w = child.getMeasuredWidth();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> h = child.getMeasuredHeight();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childTop = flowDown ? y : y - h;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (needToMeasure) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childRight = childrenLeft + w;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childBottom = childTop + h;</div><div class="line">            child.layout(childrenLeft, childTop, childRight, childBottom);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            child.offsetLeftAndRight(childrenLeft - child.getLeft());</div><div class="line">            child.offsetTopAndBottom(childTop - child.getTop());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mCachingStarted &amp;&amp; !child.isDrawingCacheEnabled()) &#123;</div><div class="line">            child.setDrawingCacheEnabled(<span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>我们会在第45行调用attachViewToParent(child, flowDown ? -1 : 0, p)，在第一次Layout过程则是执行的else语句中的addViewInLayout()方法。这两个方法最大的区别在于，如果我们需要向ViewGroup中添加一个新的子View，应该调用addViewInLayout()方法，而如果是想要将一个之前detach的View重新attach到ViewGroup上，就应该调用attachViewToParent()方法。那么由于前面在layoutChildren()方法当中调用了detachAllViewsFromParent()方法，这样ListView中所有的子View都是处于detach状态的，所以这里attachViewToParent()方法是正确的选择。</p>
<p>经历了这样一个detach又attach的过程，ListView中所有的子View又都可以正常显示出来了，那么第二次Layout过程结束。</p>
<h2 id="滑动加载更多数据"><a href="#滑动加载更多数据" class="headerlink" title="滑动加载更多数据"></a>滑动加载更多数据</h2><p>到目前只还只加载了一小部分数据，如果要加载100条，那么剩余的应该怎么去加载呢？毫无疑问动态的去加载，那么接下来我们要看的就是onTouchEvent（）方法中的，这个onTouchEvent方法在ListView找不到，那么只会在AbsListView中了。仔细思考一下也对，对于ListView还是GridView来说，最终机制都是查不了多少的，真正不同的也就放置在子View的位置不同，他们的更新数据都是滑动更新，故抽象提取出来了。</p>
<p>这个方法依然不短，同时也没有注释，到这个时候，只有发挥自己已经学过的知识了。触摸一般分为三种，按下、滑动、抬起，短暂思考，最重要无疑是重点，所以我们主要看move操作。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isEnabled()) &#123;</div><div class="line">            <span class="comment">// A disabled view that is clickable still consumes the touch</span></div><div class="line">            <span class="comment">// events, it just doesn't respond to them.</span></div><div class="line">            <span class="keyword">return</span> isClickable() || isLongClickable();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mPositionScroller != <span class="keyword">null</span>) &#123;</div><div class="line">            mPositionScroller.stop();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mIsDetaching || !isAttachedToWindow()) &#123;</div><div class="line">            <span class="comment">// Something isn't right.</span></div><div class="line">            <span class="comment">// Since we rely on being attached to get data set change notifications,</span></div><div class="line">            <span class="comment">// don't risk doing anything where we might try to resync and find things</span></div><div class="line">            <span class="comment">// in a bogus state.</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        startNestedScroll(SCROLL_AXIS_VERTICAL);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mFastScroll != <span class="keyword">null</span> &amp;&amp; mFastScroll.onTouchEvent(ev)) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        initVelocityTrackerIfNotExists();</div><div class="line">        <span class="keyword">final</span> MotionEvent vtev = MotionEvent.obtain(ev);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> actionMasked = ev.getActionMasked();</div><div class="line">        <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</div><div class="line">            mNestedYOffset = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        vtev.offsetLocation(<span class="number">0</span>, mNestedYOffset);</div><div class="line">        <span class="keyword">switch</span> (actionMasked) &#123;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN: &#123;</div><div class="line">                onTouchDown(ev);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</div><div class="line">                onTouchMove(ev, vtev);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP: &#123;</div><div class="line">                onTouchUp(ev);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_CANCEL: &#123;</div><div class="line">                onTouchCancel();</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_POINTER_UP: &#123;</div><div class="line">                onSecondaryPointerUp(ev);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> x = mMotionX;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> y = mMotionY;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> motionPosition = pointToPosition(x, y);</div><div class="line">                <span class="keyword">if</span> (motionPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">// Remember where the motion event started</span></div><div class="line">                    <span class="keyword">final</span> View child = getChildAt(motionPosition - mFirstPosition);</div><div class="line">                    mMotionViewOriginalTop = child.getTop();</div><div class="line">                    mMotionPosition = motionPosition;</div><div class="line">                &#125;</div><div class="line">                mLastY = y;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_POINTER_DOWN: &#123;</div><div class="line">                <span class="comment">// New pointers take over dragging duties</span></div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> index = ev.getActionIndex();</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> id = ev.getPointerId(index);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> x = (<span class="keyword">int</span>) ev.getX(index);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> y = (<span class="keyword">int</span>) ev.getY(index);</div><div class="line">                mMotionCorrection = <span class="number">0</span>;</div><div class="line">                mActivePointerId = id;</div><div class="line">                mMotionX = x;</div><div class="line">                mMotionY = y;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> motionPosition = pointToPosition(x, y);</div><div class="line">                <span class="keyword">if</span> (motionPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">// Remember where the motion event started</span></div><div class="line">                    <span class="keyword">final</span> View child = getChildAt(motionPosition - mFirstPosition);</div><div class="line">                    mMotionViewOriginalTop = child.getTop();</div><div class="line">                    mMotionPosition = motionPosition;</div><div class="line">                &#125;</div><div class="line">                mLastY = y;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mVelocityTracker != <span class="keyword">null</span>) &#123;</div><div class="line">            mVelocityTracker.addMovement(vtev);</div><div class="line">        &#125;</div><div class="line">        vtev.recycle();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>我们会发现mov操作中里面直接调用了onTouchMove这个方法，我们进去看一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onTouchMove</span><span class="params">(MotionEvent ev, MotionEvent vtev)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mHasPerformedLongPress) &#123;</div><div class="line">            <span class="comment">// Consume all move events following a successful long press.</span></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> pointerIndex = ev.findPointerIndex(mActivePointerId);</div><div class="line">        <span class="keyword">if</span> (pointerIndex == -<span class="number">1</span>) &#123;</div><div class="line">            pointerIndex = <span class="number">0</span>;</div><div class="line">            mActivePointerId = ev.getPointerId(pointerIndex);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mDataChanged) &#123;</div><div class="line">            <span class="comment">// Re-sync everything if data has been changed</span></div><div class="line">            <span class="comment">// since the scroll operation can query the adapter.</span></div><div class="line">            layoutChildren();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> y = (<span class="keyword">int</span>) ev.getY(pointerIndex);</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (mTouchMode) &#123;</div><div class="line">            <span class="keyword">case</span> TOUCH_MODE_DOWN:</div><div class="line">            <span class="keyword">case</span> TOUCH_MODE_TAP:</div><div class="line">            <span class="keyword">case</span> TOUCH_MODE_DONE_WAITING:</div><div class="line">                <span class="comment">// Check if we have moved far enough that it looks more like a</span></div><div class="line">                <span class="comment">// scroll than a tap. If so, we'll enter scrolling mode.</span></div><div class="line">                <span class="keyword">if</span> (startScrollIfNeeded((<span class="keyword">int</span>) ev.getX(pointerIndex), y, vtev)) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// Otherwise, check containment within list bounds. If we're</span></div><div class="line">                <span class="comment">// outside bounds, cancel any active presses.</span></div><div class="line">                <span class="keyword">final</span> View motionView = getChildAt(mMotionPosition - mFirstPosition);</div><div class="line">                <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(pointerIndex);</div><div class="line">                <span class="keyword">if</span> (!pointInView(x, y, mTouchSlop)) &#123;</div><div class="line">                    setPressed(<span class="keyword">false</span>);</div><div class="line">                    <span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">                        motionView.setPressed(<span class="keyword">false</span>);</div><div class="line">                    &#125;</div><div class="line">                    removeCallbacks(mTouchMode == TOUCH_MODE_DOWN ?</div><div class="line">                            mPendingCheckForTap : mPendingCheckForLongPress);</div><div class="line">                    mTouchMode = TOUCH_MODE_DONE_WAITING;</div><div class="line">                    updateSelectorState();</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// Still within bounds, update the hotspot.</span></div><div class="line">                    <span class="keyword">final</span> <span class="keyword">float</span>[] point = mTmpPoint;</div><div class="line">                    point[<span class="number">0</span>] = x;</div><div class="line">                    point[<span class="number">1</span>] = y;</div><div class="line">                    transformPointToViewLocal(point, motionView);</div><div class="line">                    motionView.drawableHotspotChanged(point[<span class="number">0</span>], point[<span class="number">1</span>]);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> TOUCH_MODE_SCROLL:</div><div class="line">            <span class="keyword">case</span> TOUCH_MODE_OVERSCROLL:</div><div class="line">                scrollIfNeeded((<span class="keyword">int</span>) ev.getX(pointerIndex), y, vtev);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><em>到目前为止我看的是最新的Android7.0的源码，里面很大一部分结构已经被改变，正如题目所说我是跟着郭大神的文档走的，看来到这里只能靠自己的能力了。</em></p>
<p>可以看到，这个方法里面有了一个switch语句，是根据当前的TouchMode来选择的。我看在第52行，看到一个TOUCH_MODE_SCROLL这样的一个模式，我们跟踪进入到它下面的scrollIfNeeded((int) ev.getX(pointerIndex), y, vtev)这个方法中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scrollIfNeeded</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, MotionEvent vtev)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> rawDeltaY = y - mMotionY;</div><div class="line">        <span class="keyword">int</span> scrollOffsetCorrection = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> scrollConsumedCorrection = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> (mLastY == Integer.MIN_VALUE) &#123;</div><div class="line">            rawDeltaY -= mMotionCorrection;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (dispatchNestedPreScroll(<span class="number">0</span>, mLastY != Integer.MIN_VALUE ? mLastY - y : -rawDeltaY,</div><div class="line">                mScrollConsumed, mScrollOffset)) &#123;</div><div class="line">            rawDeltaY += mScrollConsumed[<span class="number">1</span>];</div><div class="line">            scrollOffsetCorrection = -mScrollOffset[<span class="number">1</span>];</div><div class="line">            scrollConsumedCorrection = mScrollConsumed[<span class="number">1</span>];</div><div class="line">            <span class="keyword">if</span> (vtev != <span class="keyword">null</span>) &#123;</div><div class="line">                vtev.offsetLocation(<span class="number">0</span>, mScrollOffset[<span class="number">1</span>]);</div><div class="line">                mNestedYOffset += mScrollOffset[<span class="number">1</span>];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> deltaY = rawDeltaY;</div><div class="line">        <span class="keyword">int</span> incrementalDeltaY =</div><div class="line">                mLastY != Integer.MIN_VALUE ? y - mLastY + scrollConsumedCorrection : deltaY;</div><div class="line">        <span class="keyword">int</span> lastYCorrection = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mTouchMode == TOUCH_MODE_SCROLL) &#123;</div><div class="line">            <span class="keyword">if</span> (PROFILE_SCROLLING) &#123;</div><div class="line">                <span class="keyword">if</span> (!mScrollProfilingStarted) &#123;</div><div class="line">                    Debug.startMethodTracing(<span class="string">"AbsListViewScroll"</span>);</div><div class="line">                    mScrollProfilingStarted = <span class="keyword">true</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mScrollStrictSpan == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// If it's non-null, we're already in a scroll.</span></div><div class="line">                mScrollStrictSpan = StrictMode.enterCriticalSpan(<span class="string">"AbsListView-scroll"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (y != mLastY) &#123;</div><div class="line">                <span class="comment">// We may be here after stopping a fling and continuing to scroll.</span></div><div class="line">                <span class="comment">// If so, we haven't disallowed intercepting touch events yet.</span></div><div class="line">                <span class="comment">// Make sure that we do so in case we're in a parent that can intercept.</span></div><div class="line">                <span class="keyword">if</span> ((mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) == <span class="number">0</span> &amp;&amp;</div><div class="line">                        Math.abs(rawDeltaY) &gt; mTouchSlop) &#123;</div><div class="line">                    <span class="keyword">final</span> ViewParent parent = getParent();</div><div class="line">                    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">                        parent.requestDisallowInterceptTouchEvent(<span class="keyword">true</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> motionIndex;</div><div class="line">                <span class="keyword">if</span> (mMotionPosition &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    motionIndex = mMotionPosition - mFirstPosition;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// If we don't have a motion position that we can reliably track,</span></div><div class="line">                    <span class="comment">// pick something in the middle to make a best guess at things below.</span></div><div class="line">                    motionIndex = getChildCount() / <span class="number">2</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">int</span> motionViewPrevTop = <span class="number">0</span>;</div><div class="line">                View motionView = <span class="keyword">this</span>.getChildAt(motionIndex);</div><div class="line">                <span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">                    motionViewPrevTop = motionView.getTop();</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// No need to do all this work if we're not going to move anyway</span></div><div class="line">                <span class="keyword">boolean</span> atEdge = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">if</span> (incrementalDeltaY != <span class="number">0</span>) &#123;</div><div class="line">                    atEdge = trackMotionScroll(deltaY, incrementalDeltaY);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Check to see if we have bumped into the scroll limit</span></div><div class="line">                motionView = <span class="keyword">this</span>.getChildAt(motionIndex);</div><div class="line">                <span class="keyword">if</span> (motionView != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// Check if the top of the motion view is where it is</span></div><div class="line">                    <span class="comment">// supposed to be</span></div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> motionViewRealTop = motionView.getTop();</div><div class="line">                    <span class="keyword">if</span> (atEdge) &#123;</div><div class="line">                        <span class="comment">// Apply overscroll</span></div><div class="line"></div><div class="line">                        <span class="keyword">int</span> overscroll = -incrementalDeltaY -</div><div class="line">                                (motionViewRealTop - motionViewPrevTop);</div><div class="line">                        <span class="keyword">if</span> (dispatchNestedScroll(<span class="number">0</span>, overscroll - incrementalDeltaY, <span class="number">0</span>, overscroll,</div><div class="line">                                mScrollOffset)) &#123;</div><div class="line">                            lastYCorrection -= mScrollOffset[<span class="number">1</span>];</div><div class="line">                            <span class="keyword">if</span> (vtev != <span class="keyword">null</span>) &#123;</div><div class="line">                                vtev.offsetLocation(<span class="number">0</span>, mScrollOffset[<span class="number">1</span>]);</div><div class="line">                                mNestedYOffset += mScrollOffset[<span class="number">1</span>];</div><div class="line">                            &#125;</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            <span class="keyword">final</span> <span class="keyword">boolean</span> atOverscrollEdge = overScrollBy(<span class="number">0</span>, overscroll,</div><div class="line">                                    <span class="number">0</span>, mScrollY, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, mOverscrollDistance, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">                            <span class="keyword">if</span> (atOverscrollEdge &amp;&amp; mVelocityTracker != <span class="keyword">null</span>) &#123;</div><div class="line">                                <span class="comment">// Don't allow overfling if we're at the edge</span></div><div class="line">                                mVelocityTracker.clear();</div><div class="line">                            &#125;</div><div class="line"></div><div class="line">                            <span class="keyword">final</span> <span class="keyword">int</span> overscrollMode = getOverScrollMode();</div><div class="line">                            <span class="keyword">if</span> (overscrollMode == OVER_SCROLL_ALWAYS ||</div><div class="line">                                    (overscrollMode == OVER_SCROLL_IF_CONTENT_SCROLLS &amp;&amp;</div><div class="line">                                            !contentFits())) &#123;</div><div class="line">                                <span class="keyword">if</span> (!atOverscrollEdge) &#123;</div><div class="line">                                    mDirection = <span class="number">0</span>; <span class="comment">// Reset when entering overscroll.</span></div><div class="line">                                    mTouchMode = TOUCH_MODE_OVERSCROLL;</div><div class="line">                                &#125;</div><div class="line">                                <span class="keyword">if</span> (incrementalDeltaY &gt; <span class="number">0</span>) &#123;</div><div class="line">                                    mEdgeGlowTop.onPull((<span class="keyword">float</span>) -overscroll / getHeight(),</div><div class="line">                                            (<span class="keyword">float</span>) x / getWidth());</div><div class="line">                                    <span class="keyword">if</span> (!mEdgeGlowBottom.isFinished()) &#123;</div><div class="line">                                        mEdgeGlowBottom.onRelease();</div><div class="line">                                    &#125;</div><div class="line">                                    invalidateTopGlow();</div><div class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (incrementalDeltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">                                    mEdgeGlowBottom.onPull((<span class="keyword">float</span>) overscroll / getHeight(),</div><div class="line">                                            <span class="number">1</span>.f - (<span class="keyword">float</span>) x / getWidth());</div><div class="line">                                    <span class="keyword">if</span> (!mEdgeGlowTop.isFinished()) &#123;</div><div class="line">                                        mEdgeGlowTop.onRelease();</div><div class="line">                                    &#125;</div><div class="line">                                    invalidateBottomGlow();</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    mMotionY = y + lastYCorrection + scrollOffsetCorrection;</div><div class="line">                &#125;</div><div class="line">                mLastY = y + lastYCorrection + scrollOffsetCorrection;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mTouchMode == TOUCH_MODE_OVERSCROLL) &#123;</div><div class="line">            <span class="keyword">if</span> (y != mLastY) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> oldScroll = mScrollY;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> newScroll = oldScroll - incrementalDeltaY;</div><div class="line">                <span class="keyword">int</span> newDirection = y &gt; mLastY ? <span class="number">1</span> : -<span class="number">1</span>;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (mDirection == <span class="number">0</span>) &#123;</div><div class="line">                    mDirection = newDirection;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">int</span> overScrollDistance = -incrementalDeltaY;</div><div class="line">                <span class="keyword">if</span> ((newScroll &lt; <span class="number">0</span> &amp;&amp; oldScroll &gt;= <span class="number">0</span>) || (newScroll &gt; <span class="number">0</span> &amp;&amp; oldScroll &lt;= <span class="number">0</span>)) &#123;</div><div class="line">                    overScrollDistance = -oldScroll;</div><div class="line">                    incrementalDeltaY += overScrollDistance;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    incrementalDeltaY = <span class="number">0</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (overScrollDistance != <span class="number">0</span>) &#123;</div><div class="line">                    overScrollBy(<span class="number">0</span>, overScrollDistance, <span class="number">0</span>, mScrollY, <span class="number">0</span>, <span class="number">0</span>,</div><div class="line">                            <span class="number">0</span>, mOverscrollDistance, <span class="keyword">true</span>);</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> overscrollMode = getOverScrollMode();</div><div class="line">                    <span class="keyword">if</span> (overscrollMode == OVER_SCROLL_ALWAYS ||</div><div class="line">                            (overscrollMode == OVER_SCROLL_IF_CONTENT_SCROLLS &amp;&amp;</div><div class="line">                                    !contentFits())) &#123;</div><div class="line">                        <span class="keyword">if</span> (rawDeltaY &gt; <span class="number">0</span>) &#123;</div><div class="line">                            mEdgeGlowTop.onPull((<span class="keyword">float</span>) overScrollDistance / getHeight(),</div><div class="line">                                    (<span class="keyword">float</span>) x / getWidth());</div><div class="line">                            <span class="keyword">if</span> (!mEdgeGlowBottom.isFinished()) &#123;</div><div class="line">                                mEdgeGlowBottom.onRelease();</div><div class="line">                            &#125;</div><div class="line">                            invalidateTopGlow();</div><div class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rawDeltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">                            mEdgeGlowBottom.onPull((<span class="keyword">float</span>) overScrollDistance / getHeight(),</div><div class="line">                                    <span class="number">1</span>.f - (<span class="keyword">float</span>) x / getWidth());</div><div class="line">                            <span class="keyword">if</span> (!mEdgeGlowTop.isFinished()) &#123;</div><div class="line">                                mEdgeGlowTop.onRelease();</div><div class="line">                            &#125;</div><div class="line">                            invalidateBottomGlow();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (incrementalDeltaY != <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">// Coming back to 'real' list scrolling</span></div><div class="line">                    <span class="keyword">if</span> (mScrollY != <span class="number">0</span>) &#123;</div><div class="line">                        mScrollY = <span class="number">0</span>;</div><div class="line">                        invalidateParentIfNeeded();</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    trackMotionScroll(incrementalDeltaY, incrementalDeltaY);</div><div class="line"></div><div class="line">                    mTouchMode = TOUCH_MODE_SCROLL;</div><div class="line"></div><div class="line">                    <span class="comment">// We did not scroll the full amount. Treat this essentially like the</span></div><div class="line">                    <span class="comment">// start of a new touch scroll</span></div><div class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> motionPosition = findClosestMotionRow(y);</div><div class="line"></div><div class="line">                    mMotionCorrection = <span class="number">0</span>;</div><div class="line">                    View motionView = getChildAt(motionPosition - mFirstPosition);</div><div class="line">                    mMotionViewOriginalTop = motionView != <span class="keyword">null</span> ? motionView.getTop() : <span class="number">0</span>;</div><div class="line">                    mMotionY =  y + scrollOffsetCorrection;</div><div class="line">                    mMotionPosition = motionPosition;</div><div class="line">                &#125;</div><div class="line">                mLastY = y + lastYCorrection + scrollOffsetCorrection;</div><div class="line">                mDirection = newDirection;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>代码依然不短，我们往里面看在66行处发现trackMotionScroll(deltaY, incrementalDeltaY)，好吧我们找回了正轨~。名字的意思是跟踪滑动轨迹，我们进去感受一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">trackMotionScroll</span><span class="params">(<span class="keyword">int</span> deltaY, <span class="keyword">int</span> incrementalDeltaY)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> childCount = getChildCount();</div><div class="line">        <span class="keyword">if</span> (childCount == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> firstTop = getChildAt(<span class="number">0</span>).getTop();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> lastBottom = getChildAt(childCount - <span class="number">1</span>).getBottom();</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Rect listPadding = mListPadding;</div><div class="line"></div><div class="line">        <span class="comment">// "effective padding" In this case is the amount of padding that affects</span></div><div class="line">        <span class="comment">// how much space should not be filled by items. If we don't clip to padding</span></div><div class="line">        <span class="comment">// there is no effective padding.</span></div><div class="line">        <span class="keyword">int</span> effectivePaddingTop = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> effectivePaddingBottom = <span class="number">0</span>;</div><div class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">            effectivePaddingTop = listPadding.top;</div><div class="line">            effectivePaddingBottom = listPadding.bottom;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">         <span class="comment">// FIXME account for grid vertical spacing too?</span></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> spaceAbove = effectivePaddingTop - firstTop;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> end = getHeight() - effectivePaddingBottom;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> spaceBelow = lastBottom - end;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> height = getHeight() - mPaddingBottom - mPaddingTop;</div><div class="line">        <span class="keyword">if</span> (deltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">            deltaY = Math.max(-(height - <span class="number">1</span>), deltaY);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            deltaY = Math.min(height - <span class="number">1</span>, deltaY);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (incrementalDeltaY &lt; <span class="number">0</span>) &#123;</div><div class="line">            incrementalDeltaY = Math.max(-(height - <span class="number">1</span>), incrementalDeltaY);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            incrementalDeltaY = Math.min(height - <span class="number">1</span>, incrementalDeltaY);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> firstPosition = mFirstPosition;</div><div class="line"></div><div class="line">        <span class="comment">// Update our guesses for where the first and last views are</span></div><div class="line">        <span class="keyword">if</span> (firstPosition == <span class="number">0</span>) &#123;</div><div class="line">            mFirstPositionDistanceGuess = firstTop - listPadding.top;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mFirstPositionDistanceGuess += incrementalDeltaY;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (firstPosition + childCount == mItemCount) &#123;</div><div class="line">            mLastPositionDistanceGuess = lastBottom + listPadding.bottom;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mLastPositionDistanceGuess += incrementalDeltaY;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> cannotScrollDown = (firstPosition == <span class="number">0</span> &amp;&amp;</div><div class="line">                firstTop &gt;= listPadding.top &amp;&amp; incrementalDeltaY &gt;= <span class="number">0</span>);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> cannotScrollUp = (firstPosition + childCount == mItemCount &amp;&amp;</div><div class="line">                lastBottom &lt;= getHeight() - listPadding.bottom &amp;&amp; incrementalDeltaY &lt;= <span class="number">0</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (cannotScrollDown || cannotScrollUp) &#123;</div><div class="line">            <span class="keyword">return</span> incrementalDeltaY != <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> down = incrementalDeltaY &lt; <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> inTouchMode = isInTouchMode();</div><div class="line">        <span class="keyword">if</span> (inTouchMode) &#123;</div><div class="line">            hideSelector();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> headerViewsCount = getHeaderViewsCount();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> footerViewsStart = mItemCount - getFooterViewsCount();</div><div class="line"></div><div class="line">        <span class="keyword">int</span> start = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (down) &#123;</div><div class="line">            <span class="keyword">int</span> top = -incrementalDeltaY;</div><div class="line">            <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">                top += listPadding.top;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">                <span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">                <span class="keyword">if</span> (child.getBottom() &gt;= top) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    count++;</div><div class="line">                    <span class="keyword">int</span> position = firstPosition + i;</div><div class="line">                    <span class="keyword">if</span> (position &gt;= headerViewsCount &amp;&amp; position &lt; footerViewsStart) &#123;</div><div class="line">                        <span class="comment">// The view will be rebound to new data, clear any</span></div><div class="line">                        <span class="comment">// system-managed transient state.</span></div><div class="line">                        child.clearAccessibilityFocus();</div><div class="line">                        mRecycler.addScrapView(child, position);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">int</span> bottom = getHeight() - incrementalDeltaY;</div><div class="line">            <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">                bottom -= listPadding.bottom;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = childCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</div><div class="line">                <span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">                <span class="keyword">if</span> (child.getTop() &lt;= bottom) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    start = i;</div><div class="line">                    count++;</div><div class="line">                    <span class="keyword">int</span> position = firstPosition + i;</div><div class="line">                    <span class="keyword">if</span> (position &gt;= headerViewsCount &amp;&amp; position &lt; footerViewsStart) &#123;</div><div class="line">                        <span class="comment">// The view will be rebound to new data, clear any</span></div><div class="line">                        <span class="comment">// system-managed transient state.</span></div><div class="line">                        child.clearAccessibilityFocus();</div><div class="line">                        mRecycler.addScrapView(child, position);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mMotionViewNewTop = mMotionViewOriginalTop + deltaY;</div><div class="line"></div><div class="line">        mBlockLayoutRequests = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</div><div class="line">            detachViewsFromParent(start, count);</div><div class="line">            mRecycler.removeSkippedScrap();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// invalidate before moving the children to avoid unnecessary invalidate</span></div><div class="line">        <span class="comment">// calls to bubble up from the children all the way to the top</span></div><div class="line">        <span class="keyword">if</span> (!awakenScrollBars()) &#123;</div><div class="line">           invalidate();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        offsetChildrenTopAndBottom(incrementalDeltaY);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (down) &#123;</div><div class="line">            mFirstPosition += count;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> absIncrementalDeltaY = Math.abs(incrementalDeltaY);</div><div class="line">        <span class="keyword">if</span> (spaceAbove &lt; absIncrementalDeltaY || spaceBelow &lt; absIncrementalDeltaY) &#123;</div><div class="line">            fillGap(down);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mRecycler.fullyDetachScrapViews();</div><div class="line">        <span class="keyword">if</span> (!inTouchMode &amp;&amp; mSelectedPosition != INVALID_POSITION) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childIndex = mSelectedPosition - mFirstPosition;</div><div class="line">            <span class="keyword">if</span> (childIndex &gt;= <span class="number">0</span> &amp;&amp; childIndex &lt; getChildCount()) &#123;</div><div class="line">                positionSelector(mSelectedPosition, getChildAt(childIndex));</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSelectorPosition != INVALID_POSITION) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> childIndex = mSelectorPosition - mFirstPosition;</div><div class="line">            <span class="keyword">if</span> (childIndex &gt;= <span class="number">0</span> &amp;&amp; childIndex &lt; getChildCount()) &#123;</div><div class="line">                positionSelector(INVALID_POSITION, getChildAt(childIndex));</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mSelectorRect.setEmpty();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mBlockLayoutRequests = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        invokeOnItemScrollListener();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这个方法接收两个参数，deltaY表示从手指按下时的位置到当前手指位置的距离，incrementalDeltaY则表示据上次触发event事件手指在Y方向上位置的改变量，那么其实我们就可以通过incrementalDeltaY的正负值情况来判断用户是向上还是向下滑动的了。如第34行代码所示，如果incrementalDeltaY小于0，说明是向下滑动，否则就是向上滑动。</p>
<p>下面将会进行一个边界值检测的过程，可以看到，从第76行开始，当ListView向下滑动的时候，就会进入一个for循环当中，从上往下依次获取子View，第47行当中，如果该子View的bottom值已经小于top值了，就说明这个子View已经移出屏幕了，所以会调用RecycleBin的addScrapView()方法将这个View加入到废弃缓存当中，并将count计数器加1，计数器用于记录有多少个子View被移出了屏幕。那么如果是ListView向上滑动的话，其实过程是基本相同的，只不过变成了从下往上依次获取子View，然后判断该子View的top值是不是大于bottom值了，如果大于的话说明子View已经移出了屏幕，同样把它加入到废弃缓存中，并将计数器加1。<br>紧接着当着判断结束之后再134行会有offsetChildrenTopAndBottom(incrementalDeltaY)，并将incrementalDeltaY作为参数传入，这个方法的作用是让ListView中所有的子View都按照传入的参数值进行相应的偏移，这样就实现了随着手指的拖动，ListView的内容也会随着滚动的效果。</p>
<p>在第141行最后一个View被移除了屏幕，就会调用fillGap()方法的，那么我们可以认为这个方法就是来加载屏幕外的数据的</p>
<p>fillGap()是一个抽象方法，那么我们马上意识到，它的具体实现肯定是在ListView中完成的了。回到ListView当中，fillGap()方法的代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">fillGap</span><span class="params">(<span class="keyword">boolean</span> down)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</div><div class="line">        <span class="keyword">if</span> (down) &#123;</div><div class="line">            <span class="keyword">int</span> paddingTop = <span class="number">0</span>;</div><div class="line">            <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">                paddingTop = getListPaddingTop();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> startOffset = count &gt; <span class="number">0</span> ? getChildAt(count - <span class="number">1</span>).getBottom() + mDividerHeight :</div><div class="line">                    paddingTop;</div><div class="line">            fillDown(mFirstPosition + count, startOffset);</div><div class="line">            correctTooHigh(getChildCount());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">int</span> paddingBottom = <span class="number">0</span>;</div><div class="line">            <span class="keyword">if</span> ((mGroupFlags &amp; CLIP_TO_PADDING_MASK) == CLIP_TO_PADDING_MASK) &#123;</div><div class="line">                paddingBottom = getListPaddingBottom();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> startOffset = count &gt; <span class="number">0</span> ? getChildAt(<span class="number">0</span>).getTop() - mDividerHeight :</div><div class="line">                    getHeight() - paddingBottom;</div><div class="line">            fillUp(mFirstPosition - <span class="number">1</span>, startOffset);</div><div class="line">            correctTooLow(getChildCount());</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>down参数用于表示ListView是向下滑动还是向上滑动的，可以看到，如果是向下滑动的话就会调用fillDown()方法，而如果是向上滑动的话就会调用fillUp()方法。那么这两个方法我们都已经非常熟悉了，内部都是通过一个循环来去对ListView进行填充，所以这两个方法我们就不看了，但是填充ListView会通过调用makeAndAddView()方法来完成，又是makeAndAddView()方法，但这次的逻辑再次不同了，所以我们还是回到这个方法瞧一瞧：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> View <span class="title">makeAndAddView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">int</span> y, <span class="keyword">boolean</span> flow, <span class="keyword">int</span> childrenLeft,  </span></span></div><div class="line">        <span class="keyword">boolean</span> selected) &#123;  </div><div class="line">    View child;  </div><div class="line">    <span class="keyword">if</span> (!mDataChanged) &#123;  </div><div class="line">        <span class="comment">// Try to use an exsiting view for this position  </span></div><div class="line">        child = mRecycler.getActiveView(position);  </div><div class="line">        <span class="keyword">if</span> (child != <span class="keyword">null</span>) &#123;  </div><div class="line">            <span class="comment">// Found it -- we're using an existing child  </span></div><div class="line">            <span class="comment">// This just needs to be positioned  </span></div><div class="line">            setupChild(child, position, y, flow, childrenLeft, selected, <span class="keyword">true</span>);  </div><div class="line">            <span class="keyword">return</span> child;  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">    <span class="comment">// Make a new view for this position, or convert an unused view if possible  </span></div><div class="line">    child = obtainView(position, mIsScrap);  </div><div class="line">    <span class="comment">// This needs to be positioned and measured  </span></div><div class="line">    setupChild(child, position, y, flow, childrenLeft, selected, mIsScrap[<span class="number">0</span>]);  </div><div class="line">    <span class="keyword">return</span> child;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>不管怎么说，这里首先仍然是会尝试调用RecycleBin的getActiveView()方法来获取子布局，只不过肯定是获取不到的了，因为在第二次Layout过程中我们已经从mActiveViews中获取过了数据，而根据RecycleBin的机制，mActiveViews是不能够重复利用的，因此这里返回的值肯定是null,我们继续走到了obtainView中，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function">View <span class="title">obtainView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">boolean</span>[] isScrap)</span> </span>&#123;  </div><div class="line">    isScrap[<span class="number">0</span>] = <span class="keyword">false</span>;  </div><div class="line">    View scrapView;  </div><div class="line">    scrapView = mRecycler.getScrapView(position);  </div><div class="line">    View child;  </div><div class="line">    <span class="keyword">if</span> (scrapView != <span class="keyword">null</span>) &#123;  </div><div class="line">        child = mAdapter.getView(position, scrapView, <span class="keyword">this</span>);  </div><div class="line">        <span class="keyword">if</span> (child != scrapView) &#123;  </div><div class="line">            mRecycler.addScrapView(scrapView);  </div><div class="line">            <span class="keyword">if</span> (mCacheColorHint != <span class="number">0</span>) &#123;  </div><div class="line">                child.setDrawingCacheBackgroundColor(mCacheColorHint);  </div><div class="line">            &#125;  </div><div class="line">        &#125; <span class="keyword">else</span> &#123;  </div><div class="line">            isScrap[<span class="number">0</span>] = <span class="keyword">true</span>;  </div><div class="line">            dispatchFinishTemporaryDetach(child);  </div><div class="line">        &#125;  </div><div class="line">    &#125; <span class="keyword">else</span> &#123;  </div><div class="line">        child = mAdapter.getView(position, <span class="keyword">null</span>, <span class="keyword">this</span>);  </div><div class="line">        <span class="keyword">if</span> (mCacheColorHint != <span class="number">0</span>) &#123;  </div><div class="line">            child.setDrawingCacheBackgroundColor(mCacheColorHint);  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">    <span class="keyword">return</span> child;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在第四行我们会主动请求获取一个ScrapView，这个时候我们是有的，我们进入第七行，getView方法中直接将ScrapView传入，看来这个就是我们在getView中复用的convertView了。</p>
<p>到此ListView分析完毕，尽管是跟着郭神的博客走，但我是先独自很认真的看了一遍，再一个人尝试着独立分析，当中难免有不会的地方，然后再看博客，就会豁然开朗，理解更上一层楼了。写了这么多尤其还是自己主观的“独立”完成了，虽然没有把源码彻底看完，但是收获的东西真的不是一般的多，不仅收获到知识，更多的知道了下次该如何看源码，这个样的文章我还会出几篇，等我轻车熟路了，就说不写分析过程，直接写自己的探索结果了。源码不是一遍就可以看懂的，要反复认证的看才可以，毕竟是别人的东西，深得要领是有一定难度的。</p>
<p>说一下感受，看源码真是一个体力加脑力的活，你的专注力要持续的跟上，才可以见到庐山真面目啊！！！很佩服那些看源码的，真是真功夫！</p>
<p>最后附上参照博客地址<a href="http://blog.csdn.net/guolin_blog/article/details/44996879" target="_blank" rel="external"> Android ListView工作原理完全解析，带你从源码的角度彻底理解</a></p>

      
    </div>

	
	<div>
	
	<div style="text-align:center;color: #ccc;font-size:14px;">------ 本文结束 ------</div>
	
	</div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/03/11/随笔（2）/" rel="next" title="随笔（2）">
                <i class="fa fa-chevron-left"></i> 随笔（2）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/03/13/汇编语言基础之寄存器（一）/" rel="prev" title="汇编语言基础之寄存器（一）">
                汇编语言基础之寄存器（一） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          



          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="JianRan" />
          <p class="site-author-name" itemprop="name">JianRan</p>
           
              <p class="site-description motion-element" itemprop="description">做好手里面的事情</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/">
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#setAdapter-ListAdapter-adapter"><span class="nav-number">1.</span> <span class="nav-text">setAdapter(ListAdapter adapter)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第一次layout"><span class="nav-number">2.</span> <span class="nav-text">第一次layout</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第二次Layout"><span class="nav-number">3.</span> <span class="nav-text">第二次Layout</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#滑动加载更多数据"><span class="nav-number">4.</span> <span class="nav-text">滑动加载更多数据</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-https://avatars1.githubusercontent.com/u/32269?v=3&s=460"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">JianRan</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'jianran';
      var disqus_identifier = '2017/03/12/郭大神带我看ListView源码/';

      var disqus_title = "郭大神带我看ListView源码";


      function run_disqus_script(disqus_script) {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');

      

    </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
  










  
  

  

  

  

  


  

</body>
</html>
